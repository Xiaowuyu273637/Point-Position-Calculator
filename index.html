<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å­”è®¡ç®—å™¨ - é€’å¢è®¡ç®—ç‰ˆ</title>
    
    <style>
        :root {
            /* æµ…è‰²ä¸»é¢˜å˜é‡ */
            --bg-color: #f9f9f9;
            --surface-color: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --primary-color: #4285f4;
            --primary-light: #e8f4fd;
            --secondary-color: #0f9d58;
            --danger-color: #ea4335;
            --warning-color: #ff9800;
            --accent-color: #9c27b0;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --table-header-bg: #f2f2f2;
            --code-bg: #f1f1f1;
            --toggle-bg: #ffffff;
            --toggle-shadow: rgba(0, 0, 0, 0.15);
            /* ç”»å¸ƒé¢œè‰²å˜é‡ */
            --canvas-text-color: #333333;
            --canvas-axis-color: #ddd;
            --canvas-point-color: #4285f4;
            --canvas-center-color: #0f9d58;
            --canvas-start-color: #ea4335;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ–å˜é‡ */
            --touch-target-size: 44px;
        }

        [data-theme="dark"] {
            /* æ·±è‰²ä¸»é¢˜å˜é‡ */
            --bg-color: #1a1a1a;
            --surface-color: #2d2d2d;
            --text-color: #e0e0e0;
            --text-secondary: #b0b0b0;
            --primary-color: #5c9dff;
            --primary-light: #2a3b57;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #ff9800;
            --accent-color: #bb86fc;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --input-bg: #3d3d3d;
            --table-header-bg: #3a3a3a;
            --code-bg: #2a2a2a;
            --toggle-bg: #1a1a1a;
            --toggle-shadow: rgba(0, 0, 0, 0.5);
            /* ç”»å¸ƒé¢œè‰²å˜é‡ - æ·±è‰²ä¸»é¢˜ */
            --canvas-text-color: #e0e0e0;
            --canvas-axis-color: #666; /* ä¿®æ”¹ï¼šåŠ æ·±è‰²ä¸»é¢˜è½´çº¿é¢œè‰²ï¼Œä½¿å…¶å¯è§ */
            --canvas-point-color: #5c9dff;
            --canvas-center-color: #34a853;
            --canvas-start-color: #ea4335;
        }

        * {
            transition: background-color 0.3s ease, border-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            position: relative;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* ä¿®å¤ï¼šå…è®¸é¡µé¢æ»šåŠ¨ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .calculator {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        h2 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .input-section {
            background: var(--primary-light);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: var(--text-color);
        }
        
        input {
            width: 100%;
            padding: 12px; /* å¢å¤§paddingä¾¿äºè§¦æ‘¸ */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            background: var(--input-bg);
            color: var(--text-color);
            min-height: var(--touch-target-size);
        }
        
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
            font-size: 0.9em;
            min-height: var(--touch-target-size);
            transition: opacity 0.3s ease, transform 0.1s ease;
            touch-action: manipulation;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .btn-red {
            background: var(--danger-color);
        }
        
        .btn-green {
            background: var(--secondary-color);
        }
        
        .btn-purple {
            background: var(--accent-color);
        }
        
        .btn-orange {
            background: var(--warning-color);
        }
        
        .btn-blue {
            background: var(--primary-color);
        }
        
        .btn-teal {
            background: #009688;
        }
        
        #points-container {
            margin: 10px 0;
            /* ä¿®å¤ï¼šå…è®¸å®¹å™¨å†…éƒ¨æ­£å¸¸æ»šåŠ¨ */
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .point-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            padding: 8px;
            background: var(--primary-light);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            /* ä¿®å¤ï¼šå…è®¸æ­£å¸¸è§¦æ‘¸äº¤äº’ */
            user-select: none;
        }
        
        .point-item.dragging {
            opacity: 0.5;
            background: var(--code-bg);
            position: relative;
            z-index: 1000;
        }
        
        /* ä¿®å¤ï¼šæ·±è‰²æ¨¡å¼ä¸‹ç‚¹é¡¹ç›®æ ·å¼ */
        [data-theme="dark"] .point-item {
            background: #2a3b57;
            border-color: #444;
        }
        
        .point-item input {
            flex: 1;
            min-width: 100px;
            min-height: 40px;
        }
        
        .point-item button {
            flex: 0 0 auto;
            width: auto;
            padding: 8px 12px;
            min-height: 40px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .export-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            word-break: break-word;
        }
        
        th {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }
        
        canvas {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            width: 100%;
            height: auto;
            max-height: 400px;
            display: block;
            background: var(--surface-color);
            /* ä¿®å¤ï¼šç”»å¸ƒè§¦æ‘¸è¡Œä¸º */
            touch-action: none;
        }
        
        .program-display {
            margin-top: 20px;
            padding: 15px;
            background: var(--primary-light);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .program-display h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .program-content {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .format-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .format-btn {
            flex: 1;
            padding: 12px;
            background: var(--primary-light);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            font-size: 0.85em;
            min-height: var(--touch-target-size);
        }
        
        .format-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .format-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .formula-info {
            background: var(--primary-light);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9em;
        }
        
        .formula-info h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 1em;
        }
        
        .formula-info p {
            margin: 5px 0;
            color: var(--text-color);
        }
        
        .formula-info code {
            background: var(--code-bg);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-color);
        }
        
        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toggle-btn {
            flex: 1;
            min-height: var(--touch-target-size);
            /* ä¿®å¤ï¼šç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
            pointer-events: auto;
            z-index: 1;
        }
        
        .template-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background: var(--surface-color);
            z-index: 100;
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .template-panel.active {
            transform: translateX(0);
            opacity: 1;
        }
        
        .template-header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
            min-height: var(--touch-target-size);
        }
        
        .template-header h3 {
            margin: 0;
            font-size: 1.1em;
        }
        
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 24px;
            height: 18px;
            cursor: pointer;
        }
        
        .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .template-content {
            padding: 15px;
            padding-bottom: 30px;
        }
        
        .template-group {
            margin-bottom: 20px;
        }
        
        .template-group h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .template-buttons button {
            flex: 1;
            min-width: 140px;
            padding: 12px 10px;
            font-size: 0.85em;
            min-height: var(--touch-target-size);
        }
        
        .multi-template-combination {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .template-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .template-select-row select {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            min-height: var(--touch-target-size);
        }
        
        .template-select-row button {
            flex: 0 0 auto;
            width: auto;
            padding: 12px;
            min-height: var(--touch-target-size);
        }
        
        .selected-templates {
            margin-top: 10px;
            padding: 10px;
            background: var(--code-bg);
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .selected-template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            min-height: var(--touch-target-size);
        }
        
        .selected-template-item:last-child {
            border-bottom: none;
        }
        
        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-color);
            min-height: var(--touch-target-size);
        }
        
        .video-modal .modal-content {
            max-width: 800px;
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 æ¯”ä¾‹ */
            height: 0;
            overflow: hidden;
            border-radius: 4px;
            background: #000;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .video-info {
            font-size: 0.9em;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: var(--primary-light);
            border-radius: 4px;
        }
        
        .bilibili-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            text-decoration: none;
            transition: opacity 0.3s ease;
        }
        
        .bilibili-link:hover {
            opacity: 0.9;
            color: white;
            text-decoration: none;
        }
        
        .bilibili-icon {
            font-size: 1.2em;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.9em;
            border-top: 1px solid var(--border-color);
        }
        
        footer a {
            color: var(--primary-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        
        footer a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        footer .footer-text {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .incremental-calculator {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-top: 20px;
        }
        
        .incremental-controls {
            background: var(--primary-light);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--warning-color);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: bold;
        }
        
        .control-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .control-group .unit {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.8em;
            border: 1px solid var(--border-color);
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid var(--border-color);
            padding: 6px;
            text-align: center;
        }
        
        .comparison-table th {
            background-color: var(--table-header-bg);
        }
        
        .original-value {
            color: var(--text-secondary);
            text-decoration: line-through;
        }
        
        .adjusted-value {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .difference {
            font-size: 0.8em;
            color: var(--danger-color);
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--primary-light);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            min-height: var(--touch-target-size);
            /* ä¿®å¤ï¼šç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
            pointer-events: auto;
            z-index: 1;
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .incremental-template-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .incremental-template-select select {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            min-height: var(--touch-target-size);
        }
        
        .adjustment-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .adjustment-item {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .adjustment-item h4 {
            margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 1em;
        }
        
        .adjustment-values {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--primary-light);
            border-radius: 4px;
        }
        
        .value-display .label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .value-display .value {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .adjustment-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .adjustment-input input {
            flex: 1;
            text-align: right;
            border: 2px solid var(--primary-color);
            background: var(--input-bg);
            color: var(--text-color);
        }
        
        .adjustment-input input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px rgba(15, 157, 88, 0.3);
        }
        
        .adjustment-input .unit {
            font-size: 0.9em;
            color: var(--text-secondary);
            min-width: 30px;
        }
        
        /* ä¿®æ”¹.calculated-resultçš„æ ·å¼ - ä½¿ç”¨å›ºå®šå­—ä½“é¢œè‰² */
        .calculated-result {
            margin-top: 10px;
            padding: 10px;
            background: var(--primary-light);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            color: var(--text-color); /* æ”¹ä¸ºä½¿ç”¨ä¸»é¢˜å˜é‡ */
        }

        .calculated-result strong {
            color: var(--secondary-color); /* æ”¹ä¸ºä½¿ç”¨ä¸»é¢˜å˜é‡ */
        }
        
        .auto-calc-btn {
            margin-top: 15px;
            width: 100%;
        }
        
        /* ä¿®æ”¹.adjustment-explanationçš„æ ·å¼ - ä½¿ç”¨å›ºå®šå­—ä½“é¢œè‰² */
        .adjustment-explanation {
            background: var(--primary-light);
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 4px solid var(--warning-color);
            font-size: 0.9em;
        }

        .adjustment-explanation h4 {
            margin: 0 0 8px 0;
            color: var(--text-color); /* ä½¿ç”¨ä¸»é¢˜å˜é‡ */
            font-size: 1em;
        }

        .adjustment-explanation p {
            margin: 5px 0;
            color: var(--text-secondary); /* ä½¿ç”¨ä¸»é¢˜å˜é‡ */
        }
        
        .standard-value-highlight {
            background: var(--primary-light);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .standard-value-highlight h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 1em;
        }
        
        .standard-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .standard-value-item {
            text-align: center;
            padding: 8px;
            background: var(--surface-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .standard-value-item .label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .standard-value-item .value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        /* æ–°å¢æ ·å¼ */
        .template-search {
            margin-bottom: 15px;
            position: relative;
        }
        
        .template-search input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
            background: var(--input-bg);
            color: var(--text-color);
            min-height: var(--touch-target-size);
        }
        
        .template-search .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.9em;
            pointer-events: none;
        }
        
        .template-group.collapsible {
            margin-bottom: 15px;
        }
        
        .template-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            min-height: var(--touch-target-size);
        }
        
        .template-group-header h4 {
            margin: 0;
            font-size: 1em;
            color: var(--text-color);
        }
        
        .template-group-header .toggle-icon {
            color: var(--text-secondary);
            font-size: 0.9em;
            transition: transform 0.3s ease;
        }
        
        .template-group-header .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .template-group-content {
            padding-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        
        .template-group-content.collapsed {
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
        }
        
        .template-not-found {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .template-not-found.hidden {
            display: none;
        }
        
        /* æ¨¡æ¿åº“ç‚¹å‡»å¤–éƒ¨å…³é—­çš„é®ç½©å±‚ */
        .template-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 99;
        }
        
        .template-overlay.active {
            display: block;
        }
        
        /* æ‚¬æµ®çƒæ ·å¼ */
        .theme-toggle {
            position: fixed;
            cursor: grab;
            z-index: 10000;
            border: none;
            background: transparent;
            padding: 0;
            outline: none;
            user-select: none;
            touch-action: none;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, left, top;
            width: 60px;
            height: 60px;
        }

        .toggle-ball {
            width: 100%;
            height: 100%;
            background: var(--toggle-bg);
            border-radius: 50%;
            position: relative;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 32px var(--toggle-shadow),
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.1),
                inset 0 -4px 8px rgba(0, 0, 0, 0.2);
        }

        /* è¾¹ç¼˜éšè—æ•ˆæœ */
        .theme-toggle.hidden {
            transform: translateX(0%);
        }

        .theme-toggle.hidden-right {
            right: 0;
            transform: translateX(70%);
        }

        .theme-toggle.hidden-left {
            left: 0;
            transform: translateX(-70%);
        }

        /* æ‹–æ‹½çŠ¶æ€ */
        .theme-toggle.dragging {
            cursor: grabbing;
            transition: none;
        }

        .theme-toggle.dragging .toggle-ball {
            opacity: 0.8;
        }

        /* ç‚¹å‡»æ•ˆæœ */
        .theme-toggle:active:not(.dragging) .toggle-ball {
            transform: scale(0.85);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ³¢çº¹æ•ˆæœ */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: var(--text-secondary);
            opacity: 0.2;
            transform: scale(0);
            animation: rippleEffect 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        @keyframes rippleEffect {
            0% { transform: scale(0); opacity: 0.6; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* å¼€å‘è€…ä¿¡æ¯ */
        .developer-info {
            text-align: center;
            padding: 10px;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 0.8em;
            border-top: 1px solid var(--border-color);
        }
        
        .developer-info a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .developer-info a:hover {
            text-decoration: underline;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .touch-hint {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8em;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            display: none;
        }
        
        /* è™šæ‹Ÿé”®ç›˜è§¦å‘æ—¶è°ƒæ•´å¸ƒå±€ */
        @media (max-height: 500px) {
            .program-content {
                max-height: 200px;
            }
            
            .template-group-content {
                max-height: 200px;
            }
            
            .video-container {
                padding-bottom: 75%; /* 4:3 æ¯”ä¾‹ä»¥é€‚åº”æ›´å°çš„é«˜åº¦ */
            }
        }
        
        @media (max-width: 768px) {
            .template-panel {
                width: 100%;
                max-width: 100%;
            }
            
            body {
                padding: 10px;
            }
            
            .tab-container {
                flex-direction: column;
            }
            
            .adjustment-inputs {
                grid-template-columns: 1fr;
            }
            
            .theme-toggle {
                width: 50px;
                height: 50px;
            }
            
            .toggle-container {
                flex-direction: column;
            }
            
            .format-toggle {
                flex-direction: column;
            }
            
            .template-select-row {
                flex-direction: column;
            }
            
            .template-select-row button {
                width: 100%;
            }
            
            .touch-hint {
                display: block;
            }
            
            /* é˜²æ­¢iOSè¾“å…¥æ¡†ç¼©æ”¾ */
            input, select, textarea {
                font-size: 16px;
            }
            
            /* æ”¹å–„ç§»åŠ¨ç«¯æ»šåŠ¨ */
            body {
                -webkit-overflow-scrolling: touch;
                overflow-x: hidden;
            }
            
            /* ä¿®å¤ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡» */
            button {
                touch-action: manipulation;
            }
            
            .video-modal .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .point-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .point-item input, .point-item button {
                width: 100%;
            }
            
            .template-buttons button {
                min-width: 100%;
            }
            
            .export-buttons button {
                min-width: 100%;
            }
            
            h2 {
                font-size: 1.3em;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .program-content {
                font-size: 12px;
                padding: 10px;
            }
            
            .comparison-table {
                font-size: 0.7em;
            }
            
            .theme-toggle {
                width: 45px;
                height: 45px;
            }
            
            .standard-values {
                grid-template-columns: 1fr;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
            button:active {
                transform: scale(0.95);
            }
            
            .video-container {
                padding-bottom: 75%; /* ç§»åŠ¨ç«¯ä½¿ç”¨æ›´é«˜çš„æ¯”ä¾‹ */
            }
        }
    </style>
</head>
<body>
    <!-- æ‚¬æµ®çƒ -->
    <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
        <div class="toggle-ball" id="toggleBall"></div>
    </button>
    
    <!-- ç§»åŠ¨ç«¯æç¤º -->
    <div class="touch-hint" id="touchHint">
        ğŸ’¡ æç¤ºï¼šé•¿æŒ‰æ‚¬æµ®çƒå¯æ‹–åŠ¨ä½ç½®ï¼Œç‚¹å‡»åˆ‡æ¢ä¸»é¢˜
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- æ¨¡æ¿åº“é®ç½©å±‚ -->
    <div class="template-overlay" id="templateOverlay" onclick="closeTemplatePanel()"></div>
    
    <!-- ç¨‹åºåç§°è¾“å…¥æ¨¡æ€æ¡† -->
    <div class="modal" id="programNameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å¯¼å‡ºç¨‹åºæ–‡ä»¶</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="programName" class="modal-input" placeholder="è¯·è¾“å…¥ç¨‹åºåç§°ï¼ˆä¸å¸¦æ‰©å±•åï¼‰" autofocus>
            </div>
            <div class="modal-footer">
                <button onclick="closeProgramNameModal()" class="btn-red">å–æ¶ˆ</button>
                <button onclick="exportProgram()" class="btn-green">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ¿åº“é¢æ¿ -->
    <div class="template-panel" id="templatePanel">
        <div class="template-header" onclick="toggleTemplatePanel()">
            <h3>æ¨¡æ¿åº“</h3>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="template-content" id="template-content">
            <div id="template-loading">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    æ­£åœ¨åŠ è½½æ¨¡æ¿...
                </div>
            </div>
            
            <div class="template-group">
                <h4>ğŸ“¹ è§†é¢‘æ•™ç¨‹</h4>
                <div style="margin-bottom: 10px; text-align: center;">
                    <button onclick="openVideoTutorial()" class="btn-teal" style="width: 100%; padding: 15px; font-size: 1em;">
                        ğŸ¬ è§‚çœ‹è§†é¢‘æ•™ç¨‹
                    </button>
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                        å­¦ä¹ å¦‚ä½•ä½¿ç”¨äº”å­”è®¡ç®—å™¨çš„å„é¡¹åŠŸèƒ½
                    </p>
                </div>
            </div>
            
            <div class="template-group">
                <h4>åŠ è½½æ¨¡æ¿æ–‡ä»¶</h4>
                <div style="margin-bottom: 10px;">
                    <input type="file" id="template-file-input" accept=".txt" style="width: 100%; padding: 8px;">
                    <button onclick="loadTemplateFileFromInput()" class="btn-green" style="margin-top: 10px; width: 100%;">åŠ è½½æ¨¡æ¿æ–‡ä»¶</button>
                </div>
                <div style="font-size: 0.8em; color: var(--text-secondary); padding: 5px;">
                    è¯·é€‰æ‹©"æ¨¡ç‰ˆç‚¹ä½.txt"æ–‡ä»¶
                </div>
            </div>
            
            <div id="template-groups">
            </div>
            
            <div class="template-group">
                <h4>å¤šæ¨¡æ¿ç»„åˆ</h4>
                <div class="multi-template-combination">
                    <div class="template-select-row">
                        <select id="template-select">
                            <option value="">é€‰æ‹©æ¨¡æ¿æ·»åŠ åˆ°ç»„åˆ</option>
                        </select>
                        <button onclick="addTemplateToCombination()" class="btn-green">æ·»åŠ </button>
                    </div>
                    
                    <div class="selected-templates" id="selected-templates">
                        <div style="text-align: center; color: var(--text-secondary); padding: 10px;">
                            æš‚æ— é€‰æ‹©çš„æ¨¡æ¿
                        </div>
                    </div>
                    
                    <div class="template-actions">
                        <button onclick="loadMultiTemplateCombination()" class="btn-purple">åº”ç”¨ç»„åˆæ¨¡æ¿</button>
                        <button onclick="clearTemplateCombination()" class="btn-red">æ¸…ç©ºç»„åˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="tab-container">
        <button id="tab1" class="tab-btn active" onclick="switchTab(1)">äº”å­”è®¡ç®—å™¨</button>
        <button id="tab2" class="tab-btn" onclick="switchTab(2)">é€’å¢è®¡ç®—å™¨</button>
    </div>
    
    <!-- äº”å­”è®¡ç®—å™¨æ ‡ç­¾é¡µ -->
    <div id="calculator-tab" class="calculator tab-content active">
        <h2>äº”å­”è®¡ç®—å™¨</h2>
        
        <div class="toggle-container">
            <button id="toggleCanvasBtn" onclick="toggleCanvas()" class="toggle-btn btn-green">éšè—å›¾å½¢</button>
            <button onclick="reversePoints()" class="toggle-btn">åè½¬é¡ºåº</button>
            <button onclick="toggleTemplatePanel()" class="toggle-btn btn-purple">æ¨¡æ¿åº“</button>
            <button onclick="openVideoTutorial()" class="toggle-btn btn-teal">è§†é¢‘æ•™ç¨‹</button>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <label>åœ†å¿ƒ (å›ºå®šç‚¹):</label>
                <div>(0, 0)</div>
            </div>
            
            <div class="input-group">
                <label for="startX">èµ·ç‚¹ X:</label>
                <input type="number" id="startX" placeholder="Xåæ ‡" step="0.1" value="0" inputmode="decimal">
                <label for="startY">èµ·ç‚¹ Y:</label>
                <input type="number" id="startY" placeholder="Yåæ ‡" step="0.1" value="-35" inputmode="decimal">
                <button onclick="updateStartPoint()" class="btn-green">æ›´æ–°èµ·ç‚¹</button>
            </div>
            
            <div class="input-group">
                <label>æ·»åŠ è·¯å¾„ç‚¹ï¼š</label>
                <input type="number" id="newX" placeholder="Xåæ ‡" step="0.1" inputmode="decimal">
                <input type="number" id="newY" placeholder="Yåæ ‡" step="0.1" inputmode="decimal">
                <button onclick="addPoint()">æ·»åŠ ç‚¹</button>
                <button onclick="clearAll()" class="btn-red">æ¸…ç©ºæ‰€æœ‰ç‚¹</button>
            </div>
        </div>
        
        <div id="points-container"></div>
        
        <div id="results">
            <h3>è®¡ç®—ç»“æœï¼š</h3>
            <table id="result-table">
                <thead>
                    <tr>
                        <th>æ‰‡å½¢</th>
                        <th>èµ·ç‚¹åæ ‡</th>
                        <th>ç»ˆç‚¹åæ ‡</th>
                        <th>åœ†å¿ƒåˆ°ç‚¹è·ç¦»</th>
                        <th>è§’åº¦(Â°)</th>
                        <th>ç›´å¾„</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <canvas id="diagram"></canvas>
        
        <div class="program-display">
            <h3>ç”Ÿæˆç¨‹åº <span style="font-size: 0.8em; color: var(--text-secondary);">ï¼ˆç¨‹åºæ ¼å¼ï¼‰</span></h3>
            
            <div class="format-label">é€‰æ‹©ç¨‹åºæ ¼å¼ï¼š</div>
            <div class="format-toggle">
                <button id="format1Btn" class="format-btn active" onclick="switchFormat(1)">æ ¼å¼1 (å•ç¨‹åº $1)</button>
                <button id="format2Btn" class="format-btn" onclick="switchFormat(2)">æ ¼å¼2 (åŒç¨‹åº $1 + $2)</button>
            </div>
            
            <div class="formula-info">
                <h4>è®¡ç®—å…¬å¼è¯´æ˜ï¼š</h4>
                <p>1. <strong>Xå€¼è®¡ç®—</strong>ï¼š<code>X = è·ç¦»(Oâ†’ç‚¹) Ã— 2</code></p>
                <p>2. <strong>Cå€¼è®¡ç®—</strong>ï¼šç´¯ç§¯è§’åº¦ï¼ˆä»0Â°å¼€å§‹ç´¯åŠ æ¯ä¸ªæ‰‡å½¢è§’åº¦ï¼‰</p>
                <p style="margin-left: 15px;">â€¢ é™„åŠ æ¨¡æ¿ä¸­ï¼Œå¦‚æœä¸¤ç‚¹è¿‡è¿‘ï¼Œè§’åº¦ä¼šç”¨è´Ÿæ•°åå‘é€’å¢</p>
                <p style="margin-left: 15px;">â€¢ å¤šæ¨¡æ¿ç»„åˆæ—¶ï¼Œç‚¹ç¼–å·ä¼šä»æ¨¡æ¿ç¼–å·é‡æ–°é€’å¢</p>
                <p>3. <strong>ç¨‹åºæ ¼å¼</strong>ï¼š</p>
                <p style="margin-left: 15px;">â€¢ <strong>æ ¼å¼1</strong>ï¼šå®Œæ•´çš„å•ç¨‹åºï¼ŒåŒ…å«å®Œæ•´çš„åŠ å·¥æµç¨‹</p>
                <p style="margin-left: 15px;">â€¢ <strong>æ ¼å¼2</strong>ï¼šåŒç¨‹åºæ ¼å¼ï¼Œ$1åŒ…å«å®Œæ•´ç¨‹åºï¼Œ$2ä¸ºç©º</p>
            </div>
            
            <div class="program-content" id="programContent">
                æš‚æ— ç¨‹åºæ•°æ®ï¼Œè¯·å…ˆåŠ è½½æ¨¡æ¿æˆ–æ·»åŠ ç‚¹ã€‚
            </div>
            <div class="export-buttons">
                <button onclick="openVideoTutorial()" class="btn-teal">ğŸ“¹ è§†é¢‘æ•™ç¨‹</button>
                <button onclick="openProgramNameModal()" class="btn-orange">å¯¼å‡ºç¨‹åº</button>
            </div>
        </div>
    </div>
    
    <!-- é€’å¢è®¡ç®—å™¨æ ‡ç­¾é¡µ -->
    <div id="incremental-tab" class="incremental-calculator tab-content">
        <h2>é€’å¢è®¡ç®—å™¨</h2>
        
        <div class="incremental-controls">
            <h4>æ¨¡æ¿é€‰æ‹©ä¸è°ƒæ•´è®¾ç½®</h4>
            
            <div class="control-group">
                <label>æ¨¡æ¿ä¿¡æ¯ï¼š</label>
                <div class="value-display" style="margin-bottom: 15px; background: var(--primary-light);">
                    <span class="label">å½“å‰é€‰æ‹©ï¼š</span>
                    <span class="value" id="templateInfoText">æœªé€‰æ‹©æ¨¡æ¿</span>
                </div>
                <div class="unit">è¯·ä»æ¨¡æ¿åº“ä¸­é€‰æ‹©æ¨¡æ¿</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="toggleTemplatePanel()" class="btn-purple" style="flex: 1;">æ‰“å¼€æ¨¡æ¿åº“</button>
                    <button onclick="openVideoTutorial()" class="btn-teal" style="flex: 1;">è§†é¢‘æ•™ç¨‹</button>
                </div>
            </div>
            
            <div id="standardValueHighlight" class="standard-value-highlight" style="display: none;">
                <h4>æ ‡å‡†å€¼ä¿¡æ¯</h4>
                <div class="standard-values">
                    <div class="standard-value-item">
                        <div class="label">æ ‡å‡†Xå€¼</div>
                        <div class="value" id="standardXValueDisplay">0.00</div>
                    </div>
                    <div class="standard-value-item">
                        <div class="label">æ ‡å‡†Cå€¼</div>
                        <div class="value" id="standardCValueDisplay">0.00</div>
                    </div>
                </div>
                <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                    æ³¨ï¼šæ ‡å‡†å€¼ä¸ºç¨‹åºä¸­ç¬¬ä¸€ä¸ªç‚¹çš„Xå’ŒCå€¼
                </div>
            </div>
            
            <div class="adjustment-inputs">
                <div class="adjustment-item">
                    <h4>Xå€¼è°ƒæ•´</h4>
                    <div class="adjustment-values">
                        <div class="value-display">
                            <span class="label">æ ‡å‡†Xå€¼ï¼š</span>
                            <span class="value" id="standardXValue">--</span>
                        </div>
                        <div class="adjustment-input">
                            <input type="number" id="xAdjustment" step="0.01" value="0.00" placeholder="è¾“å…¥è°ƒæ•´å€¼" inputmode="decimal">
                            <span class="unit">mm</span>
                        </div>
                        <div class="calculated-result">
                            è°ƒæ•´åXå€¼ï¼š<strong id="adjustedXValue">--</strong> mm
                        </div>
                    </div>
                </div>
                
                <div class="adjustment-item">
                    <h4>Cå€¼è°ƒæ•´</h4>
                    <div class="adjustment-values">
                        <div class="value-display">
                            <span class="label">æ ‡å‡†Cå€¼ï¼š</span>
                            <span class="value" id="standardCValue">0.00</span>
                        </div>
                        <div class="adjustment-input">
                            <input type="number" id="cAdjustment" step="0.01" value="0.00" placeholder="è¾“å…¥è°ƒæ•´å€¼" inputmode="decimal">
                            <span class="unit">Â°</span>
                        </div>
                        <div class="calculated-result">
                            è°ƒæ•´åCå€¼ï¼š<strong id="adjustedCValue">0.00</strong> Â°
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="applyAdjustments()" class="btn-green auto-calc-btn">åº”ç”¨è°ƒæ•´å¹¶è®¡ç®—ç¨‹åº</button>
            <button onclick="resetAdjustments()" class="btn-red" style="margin-top: 10px; width: 100%;">é‡ç½®è°ƒæ•´å€¼</button>
            
            <div class="adjustment-explanation">
                <h4>ä½¿ç”¨è¯´æ˜</h4>
                <p>1. <strong>é€‰æ‹©æ¨¡æ¿</strong>ï¼šä»æ¨¡æ¿åº“é€‰æ‹©è¦è°ƒæ•´çš„æ¨¡æ¿</p>
                <p>2. <strong>æŸ¥çœ‹æ ‡å‡†å€¼</strong>ï¼šç³»ç»Ÿè‡ªåŠ¨æ˜¾ç¤ºç¨‹åºä¸­ç¬¬ä¸€ä¸ªç‚¹çš„æ ‡å‡†Xå€¼å’ŒCå€¼</p>
                <p>3. <strong>è¾“å…¥è°ƒæ•´å€¼</strong>ï¼š</p>
                <p style="margin-left: 15px;">â€¢ å¦‚æœéœ€è¦å‡å°ï¼Œè¾“å…¥è´Ÿæ•°ï¼ˆå¦‚ï¼š-0.26ï¼‰</p>
                <p style="margin-left: 15px;">â€¢ å¦‚æœéœ€è¦å¢å¤§ï¼Œè¾“å…¥æ­£æ•°ï¼ˆå¦‚ï¼š+0.10ï¼‰</p>
                <p>4. <strong>åº”ç”¨è°ƒæ•´</strong>ï¼šç‚¹å‡»æŒ‰é’®åº”ç”¨è°ƒæ•´å¹¶ç”Ÿæˆæ–°ç¨‹åº</p>
                <p>5. <strong>å¯¼å‡ºç¨‹åº</strong>ï¼šå¯¼å‡ºè°ƒæ•´åçš„ç¨‹åºç”¨äºåŠ å·¥</p>
                <p><strong>æ³¨æ„</strong>ï¼šè°ƒæ•´å€¼ä¼šåº”ç”¨åˆ°ç¨‹åºä¸­çš„æ‰€æœ‰ç‚¹</p>
            </div>
        </div>
        
        <div class="program-display">
            <h3>è°ƒæ•´åçš„ç¨‹åº</h3>
            
            <div class="program-content" id="adjustedProgramContent">
                è¯·å…ˆé€‰æ‹©æ¨¡æ¿å¹¶è®¾ç½®è°ƒæ•´å€¼ã€‚
            </div>
            
            <div class="export-buttons">
                <button onclick="openVideoTutorial()" class="btn-teal">ğŸ“¹ è§†é¢‘æ•™ç¨‹</button>
                <button onclick="exportAdjustedProgram()" class="btn-orange">å¯¼å‡ºè°ƒæ•´åçš„ç¨‹åº</button>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <h4>è¯¯å·®å¯¹æ¯”è¡¨</h4>
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>ç‚¹å·</th>
                        <th>åŸXå€¼</th>
                        <th>è°ƒæ•´åXå€¼</th>
                        <th>Xè¯¯å·®</th>
                        <th>åŸCå€¼</th>
                        <th>è°ƒæ•´åCå€¼</th>
                        <th>Cè¯¯å·®</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            è¯·å…ˆé€‰æ‹©æ¨¡æ¿å¹¶è®¡ç®—
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>
            <a href="https://github.com/Xiaowuyu273637/Five-hole-calculator" 
               target="_blank">
                ğŸŒŸ GitHubä»“åº“: https://github.com/Xiaowuyu273637/Five-hole-calculator
            </a>
        </p>
        <div class="developer-info">
            <p>
                <strong>ğŸ‘¤ å¼€å‘è€…ï¼šå°æ— é±¼</strong> | 
                <strong>ğŸ¤– AIåŠ©æ‰‹ï¼šDeepSeek</strong> | 
                <strong>ğŸš€ å…±åŒå¼€å‘</strong>
            </p>
            <p class="footer-text">
                äº”å­”è®¡ç®—å™¨ - é€’å¢è®¡ç®—ç‰ˆ - ä¸“ä¸šçš„äº”å­”è®¡ç®—å·¥å…· | v2.2 è§†é¢‘æ•™ç¨‹ç‰ˆ
            </p>
            <p style="margin-top: 10px;">
                <a href="https://www.bilibili.com/video/BV1PoBQBSEaX/" target="_blank">
                    ğŸ“¹ è§†é¢‘æ•™ç¨‹ï¼šhttps://www.bilibili.com/video/BV1PoBQBSEaX/
                </a>
            </p>
        </div>
    </footer>

    <script>
        // äº”å­”è®¡ç®—å™¨æ ¸å¿ƒå˜é‡
        const O = { x: 0, y: 0 };
        let A = { x: 0, y: -35 };
        let points = [];
        let canvasVisible = true;
        let dragItem = null;
        let product = Math.abs(A.y) * 2;
        let isCombinationMode = false;
        let selectedTemplates = [];
        let currentFormat = 1;
        let templates = {};
        
        let calculatedResults = [];
        let templatePointGroups = [];
        let originalProgramLines = [];
        
        let xAdjustment = 0;
        let cAdjustment = 0;
        
        let incrementalSelectedTemplate = null;
        let standardXValue = 0;
        let standardCValue = 0;
        
        // å­˜å‚¨æ¨¡æ¿ç»„çš„å±•å¼€çŠ¶æ€
        let templateGroupStates = {
            'ä¸»è½´æ¨¡æ¿': true,
            'ä¸‹è½´æ¨¡æ¿': true,
            'ç‰¹åˆ«ç‰ˆæ¨¡æ¿': true,
            'é™„åŠ æ¨¡æ¿': false,
            'å…¶ä»–æ¨¡æ¿': true
        };
        
        // å­˜å‚¨æœç´¢å…³é”®è¯
        let searchKeywords = {};
        
        // GitHub æ¨¡æ¿æ–‡ä»¶URL
        const GITHUB_TEMPLATE_URL = 'https://raw.githubusercontent.com/Xiaowuyu273637/Five-hole-calculator/main/%E6%A8%A1%E7%89%88%E7%82%B9%E4%BD%8D.txt';
        
        // Bç«™è§†é¢‘æ•™ç¨‹URL
        const BILIBILI_VIDEO_URL = 'https://www.bilibili.com/video/BV1PoBQBSEaX/';
        
        // ç§»åŠ¨ç«¯æ£€æµ‹
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // ========== è§†é¢‘æ•™ç¨‹åŠŸèƒ½ ==========
        function openVideoTutorial() {
            window.open('https://www.bilibili.com/video/BV1PoBQBSEaX/?vd_source=6af4db5cdbf72b2d4ced3337fdf5d7f6', '_blank');
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // ========== æ‚¬æµ®çƒç±»ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆï¼‰==========
        class EdgeHideToggle {
            constructor(options = {}) {
                this.options = {
                    ballSize: isMobile ? 50 : 60,
                    hideThreshold: 30,
                    hideDelay: 2000,
                    longPressDelay: 300,
                    clickMaxMove: isMobile ? 10 : 5, // ç§»åŠ¨ç«¯å¢åŠ å®¹å·®
                    deceleration: 0.95,
                    minVelocity: 0.5,
                    enableInertia: true,
                    enableEdgeHide: true,
                    enableVibrate: isMobile, // ç§»åŠ¨ç«¯å¯ç”¨éœ‡åŠ¨åé¦ˆ
                    ...options
                };

                this.toggleBtn = document.getElementById('themeToggle');
                this.toggleBall = document.getElementById('toggleBall');
                this.body = document.body;
                this.touchHint = document.getElementById('touchHint');
                
                this.isDragging = false;
                this.isLongPress = false;
                this.startTime = 0;
                this.startX = 0;
                this.startY = 0;
                this.velocityX = 0;
                this.velocityY = 0;
                this.animationId = null;
                this.hideTimer = null;
                
                this.minX = 0;
                this.minY = 0;
                this.maxX = 0;
                this.maxY = 0;
                
                this.init();
            }

            init() {
                this.toggleBall.style.width = `${this.options.ballSize}px`;
                this.toggleBall.style.height = `${this.options.ballSize}px`;
                
                this.updateBoundaries();
                const savedPos = localStorage.getItem('togglePosition');
                if (savedPos) {
                    const { x, y } = JSON.parse(savedPos);
                    this.setPosition(x, y);
                } else {
                    // ç§»åŠ¨ç«¯é»˜è®¤ä½ç½®ï¼šå³ä¸‹è§’
                    this.setPosition(this.maxX - 10, this.maxY - 10);
                }
                
                const savedTheme = localStorage.getItem('theme') || 'light';
                this.setTheme(savedTheme, false);
                
                this.bindEvents();
                window.addEventListener('resize', () => this.updateBoundaries());
                this.startHideCheck();
            }

            bindEvents() {
                // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                this.toggleBtn.addEventListener('mousedown', (e) => this.handleStart(e));
                document.addEventListener('mousemove', (e) => this.handleMove(e));
                document.addEventListener('mouseup', (e) => this.handleEnd(e));

                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                this.toggleBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.handleStart(e.touches[0]);
                });
                
                document.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) this.handleMove(e.touches[0]);
                });
                
                document.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (e.changedTouches.length > 0) this.handleEnd(e.changedTouches[0]);
                });

                // é˜²æ­¢é€‰æ‹©æ–‡æœ¬å’Œå³é”®èœå•
                this.toggleBtn.addEventListener('selectstart', (e) => e.preventDefault());
                this.toggleBtn.addEventListener('contextmenu', (e) => e.preventDefault());
            }

            handleStart(e) {
                this.startTime = Date.now();
                this.isLongPress = false;
                this.isDragging = false;
                this.stopHide();
                this.show();
                
                // éšè—æç¤º
                if (this.touchHint) this.touchHint.style.display = 'none';
                
                this.startX = e.clientX || e.pageX;
                this.startY = e.clientY || e.pageY;
                this.lastX = e.clientX || e.pageX;
                this.lastY = e.clientY || e.pageY;
                this.lastTime = Date.now();
                
                const rect = this.toggleBtn.getBoundingClientRect();
                this.initialX = rect.left;
                this.initialY = rect.top;
                
                this.longPressTimer = setTimeout(() => {
                    this.isLongPress = true;
                    this.startDrag();
                    // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
                    if (this.options.enableVibrate && navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, this.options.longPressDelay);
            }

            handleMove(e) {
                if (!this.startX || !this.startY) return;
                
                const currentTime = Date.now();
                const deltaTime = currentTime - this.lastTime;
                
                const clientX = e.clientX || e.pageX;
                const clientY = e.clientY || e.pageY;
                
                if (deltaTime > 0) {
                    const deltaX = clientX - this.lastX;
                    const deltaY = clientY - this.lastY;
                    
                    this.velocityX = deltaX / deltaTime * 1000;
                    this.velocityY = deltaY / deltaTime * 1000;
                    
                    this.lastX = clientX;
                    this.lastY = clientY;
                    this.lastTime = currentTime;
                }
                
                if (!this.isDragging) {
                    const movedDistance = Math.sqrt(
                        Math.pow(clientX - this.startX, 2) + 
                        Math.pow(clientY - this.startY, 2)
                    );
                    
                    if (movedDistance > this.options.clickMaxMove) {
                        clearTimeout(this.longPressTimer);
                        this.startDrag();
                    }
                }
                
                if (this.isDragging) {
                    this.drag(e);
                }
            }

            handleEnd(e) {
                clearTimeout(this.longPressTimer);
                
                const endTime = Date.now();
                const pressDuration = endTime - this.startTime;
                const clientX = e.clientX || e.pageX;
                const clientY = e.clientY || e.pageY;
                const movedDistance = Math.sqrt(
                    Math.pow(clientX - this.startX, 2) + 
                    Math.pow(clientY - this.startY, 2)
                );
                
                if (this.isDragging) {
                    if (this.options.enableInertia) {
                        this.startInertia();
                    }
                    this.savePosition();
                    // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
                    if (this.options.enableVibrate && navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                } else if (pressDuration < this.options.longPressDelay && 
                          movedDistance < this.options.clickMaxMove) {
                    this.toggleTheme();
                    // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
                    if (this.options.enableVibrate && navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                }
                
                this.resetDragState();
                this.startHideCheck();
            }

            startDrag() {
                this.isDragging = true;
                this.toggleBtn.classList.add('dragging');
                this.updateBoundaries();
            }

            drag(e) {
                const clientX = e.clientX || e.pageX;
                const clientY = e.clientY || e.pageY;
                const dx = clientX - this.startX;
                const dy = clientY - this.startY;
                
                let newX = this.initialX + dx;
                let newY = this.initialY + dy;
                
                newX = Math.max(this.minX, Math.min(newX, this.maxX));
                newY = Math.max(this.minY, Math.min(newY, this.maxY));
                
                this.setPosition(newX, newY);
            }

            startInertia() {
                if (Math.abs(this.velocityX) < 1 && Math.abs(this.velocityY) < 1) {
                    this.stopDrag();
                    return;
                }
                
                this.applyInertia();
            }

            applyInertia() {
                if (!this.isDragging && (Math.abs(this.velocityX) > this.options.minVelocity || 
                                         Math.abs(this.velocityY) > this.options.minVelocity)) {
                    
                    const rect = this.toggleBtn.getBoundingClientRect();
                    let newX = rect.left + this.velocityX * 0.016;
                    let newY = rect.top + this.velocityY * 0.016;
                    
                    if (newX < this.minX || newX > this.maxX) {
                        this.velocityX *= -0.6;
                        newX = newX < this.minX ? this.minX : this.maxX;
                    }
                    
                    if (newY < this.minY || newY > this.maxY) {
                        this.velocityY *= -0.6;
                        newY = newY < this.minY ? this.minY : this.maxY;
                    }
                    
                    this.setPosition(newX, newY);
                    
                    this.velocityX *= this.options.deceleration;
                    this.velocityY *= this.options.deceleration;
                    
                    this.animationId = requestAnimationFrame(() => this.applyInertia());
                } else {
                    this.stopDrag();
                }
            }

            stopDrag() {
                this.isDragging = false;
                this.toggleBtn.classList.remove('dragging');
                
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            resetDragState() {
                this.startX = 0;
                this.startY = 0;
                this.initialX = 0;
                this.initialY = 0;
                this.velocityX = 0;
                this.velocityY = 0;
            }

            startHideCheck() {
                if (!this.options.enableEdgeHide) return;
                
                clearTimeout(this.hideTimer);
                this.hideTimer = setTimeout(() => {
                    this.checkEdgeHide();
                }, this.options.hideDelay);
            }

            stopHide() {
                clearTimeout(this.hideTimer);
            }

            checkEdgeHide() {
                const rect = this.toggleBtn.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                this.toggleBtn.classList.remove('hidden', 'hidden-left', 'hidden-right');
                
                const isNearLeft = rect.left < this.options.hideThreshold;
                const isNearRight = rect.left > screenWidth - rect.width - this.options.hideThreshold;
                const isNearTop = rect.top < this.options.hideThreshold;
                const isNearBottom = rect.top > screenHeight - rect.height - this.options.hideThreshold;
                
                if (isNearLeft) {
                    this.toggleBtn.classList.add('hidden', 'hidden-left');
                } else if (isNearRight) {
                    this.toggleBtn.classList.add('hidden', 'hidden-right');
                } else if (isNearTop || isNearBottom) {
                    this.toggleBtn.classList.add('hidden');
                }
            }

            show() {
                this.toggleBtn.classList.remove('hidden', 'hidden-left', 'hidden-right');
            }

            setPosition(x, y) {
                this.toggleBtn.style.left = `${x}px`;
                this.toggleBtn.style.top = `${y}px`;
            }

            savePosition() {
                const rect = this.toggleBtn.getBoundingClientRect();
                localStorage.setItem('togglePosition', JSON.stringify({
                    x: rect.left,
                    y: rect.top
                }));
            }

            updateBoundaries() {
                this.maxX = window.innerWidth - this.options.ballSize;
                this.maxY = window.innerHeight - this.options.ballSize;
                
                const rect = this.toggleBtn.getBoundingClientRect();
                let x = Math.max(this.minX, Math.min(rect.left, this.maxX));
                let y = Math.max(this.minY, Math.min(rect.top, this.maxY));
                
                this.setPosition(x, y);
                this.savePosition();
            }

            toggleTheme() {
                const currentTheme = this.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme, true);
            }

            setTheme(theme, animate = true) {
                if (animate) {
                    this.createRipple();
                    setTimeout(() => {
                        this.body.setAttribute('data-theme', theme);
                        localStorage.setItem('theme', theme);
                        this.updateColors();
                        
                        // ç¡®ä¿CSSå˜é‡å®Œå…¨æ›´æ–°åé‡ç»˜ç”»å¸ƒ
                        setTimeout(() => {
                            if (points.length > 0 && canvasVisible) {
                                forceRedrawCanvas();
                            }
                        }, 50);
                    }, 100);
                } else {
                    this.body.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    this.updateColors();
                    
                    // ç¡®ä¿CSSå˜é‡å®Œå…¨æ›´æ–°åé‡ç»˜ç”»å¸ƒ
                    setTimeout(() => {
                        if (points.length > 0 && canvasVisible) {
                            forceRedrawCanvas();
                        }
                    }, 50);
                }
            }
            
            updateColors() {
                const isDark = this.body.getAttribute('data-theme') === 'dark';
                const root = document.documentElement;
                
                if (isDark) {
                    root.style.setProperty('--toggle-bg', '#1a1a1a');
                    root.style.setProperty('--toggle-shadow', 'rgba(0, 0, 0, 0.5)');
                } else {
                    root.style.setProperty('--toggle-bg', '#ffffff');
                    root.style.setProperty('--toggle-shadow', 'rgba(0, 0, 0, 0.15)');
                }
            }

            createRipple() {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                
                const rect = this.toggleBall.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = rect.width / 2 - size / 2;
                const y = rect.height / 2 - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                this.toggleBall.appendChild(ripple);
                setTimeout(() => ripple.remove(), 800);
            }
        }
        
        // ========== ç”»å¸ƒå¼ºåˆ¶é‡ç»˜å‡½æ•° ==========
        function forceRedrawCanvas() {
            if (!canvas || !ctx || !canvasVisible) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å¦‚æœæœ‰ç‚¹æ•°æ®ï¼Œé‡æ–°ç»˜åˆ¶
            if (points.length > 0 && calculatedResults.length > 0) {
                drawDiagram(calculatedResults);
            } else {
                // ç»˜åˆ¶åæ ‡è½´
                const allPoints = [O, A, ...points];
                const { scale, offsetX, offsetY } = calculateViewport(allPoints);
                drawAxes(scale, offsetX, offsetY);
            }
        }
        
        // ========== æ¨¡æ¿ç›¸å…³å‡½æ•° ==========
        function parseTemplateFile(content) {
            const templates = {};
            const lines = content.split('\n');
            let currentCategory = '';
            let currentTemplateName = '';
            let parsingTemplate = false;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.includes('æ¨¡ç‰ˆ') || line.includes('æ¨¡æ¿')) {
                    if (parsingTemplate && currentTemplateName) {
                        templates[currentTemplateName] = {
                            points: parsePoints(currentPoints),
                            origin: currentOrigin,
                            category: currentCategory
                        };
                    }
                    
                    parsingTemplate = false;
                    
                    if (line.includes('ä¸»è½´')) {
                        currentCategory = 'ä¸»è½´æ¨¡æ¿';
                    } else if (line.includes('ä¸‹è½´')) {
                        currentCategory = 'ä¸‹è½´æ¨¡æ¿';
                    } else if (line.includes('ç‰¹åˆ«ç‰ˆ')) {
                        currentCategory = 'ç‰¹åˆ«ç‰ˆæ¨¡æ¿';
                    } else {
                        currentCategory = 'é™„åŠ æ¨¡æ¿';
                    }
                    
                    const templateMatch = line.match(/(.*?)(?:æ¨¡ç‰ˆ|æ¨¡æ¿)åŸç‚¹ï¼š/);
                    if (templateMatch) {
                        currentTemplateName = templateMatch[1].trim();
                        parsingTemplate = true;
                        
                        const originMatch = line.match(/X([-\d.]+),Y([-\d.]+)/);
                        if (originMatch) {
                            currentOrigin = {
                                x: parseFloat(originMatch[1]),
                                y: parseFloat(originMatch[2])
                            };
                        } else {
                            currentOrigin = null;
                        }
                        
                        const pointsMatch = line.match(/ç¤ºä¾‹ç‚¹ï¼š(.*)$/);
                        if (pointsMatch) {
                            currentPoints = pointsMatch[1];
                        } else {
                            currentPoints = '';
                        }
                    }
                }
                else if (line.includes('æ’æ°”å­”') || line.includes('æ²‰å­”') || line.includes('å®šä½å­”') || 
                         line.includes('æ ‡è®°å­”') || line.includes('æ ‡è®°ç‚¹') || line.includes('ç²—é“£')) {
                    if (parsingTemplate && currentTemplateName) {
                        templates[currentTemplateName] = {
                            points: parsePoints(currentPoints),
                            origin: currentOrigin,
                            category: currentCategory
                        };
                    }
                    
                    parsingTemplate = true;
                    currentCategory = 'é™„åŠ æ¨¡æ¿';
                    currentOrigin = null;
                    
                    const colonIndex = line.indexOf('ï¼š');
                    if (colonIndex !== -1) {
                        currentTemplateName = line.substring(0, colonIndex).trim();
                        currentPoints = line.substring(colonIndex + 1).trim();
                    } else {
                        const parts = line.split(/:|ï¼š/);
                        if (parts.length >= 2) {
                            currentTemplateName = parts[0].trim();
                            currentPoints = parts.slice(1).join(':').trim();
                        } else {
                            currentTemplateName = line.trim();
                            currentPoints = '';
                        }
                    }
                }
                else if (/^[^ï¼š]+[ï¼š:]\s*/.test(line)) {
                    if (parsingTemplate && currentTemplateName) {
                        templates[currentTemplateName] = {
                            points: parsePoints(currentPoints),
                            origin: currentOrigin,
                            category: currentCategory
                        };
                    }
                    
                    parsingTemplate = true;
                    currentCategory = 'é™„åŠ æ¨¡æ¿';
                    currentOrigin = null;
                    
                    const parts = line.split(/[ï¼š:]/);
                    currentTemplateName = parts[0].trim();
                    if (parts.length > 1) {
                        currentPoints = parts.slice(1).join(':').trim();
                    } else {
                        currentPoints = '';
                    }
                }
                else if (parsingTemplate) {
                    currentPoints += ' ' + line;
                }
            }
            
            if (parsingTemplate && currentTemplateName) {
                templates[currentTemplateName] = {
                    points: parsePoints(currentPoints),
                    origin: currentOrigin,
                    category: currentCategory
                };
            }
            
            return templates;
        }
        
        function parsePoints(pointsStr) {
            if (!pointsStr) return [];
            
            const points = [];
            pointsStr = pointsStr.replace(/ï¼Œ/g, ',').replace(/,/g, ' ').replace(/\s+/g, ' ').trim();
            const coords = pointsStr.split(' ');
            
            for (let i = 0; i < coords.length; i += 2) {
                if (i + 1 < coords.length) {
                    const x = parseFloat(coords[i]);
                    const y = parseFloat(coords[i + 1]);
                    if (!isNaN(x) && !isNaN(y)) {
                        points.push({ x, y });
                    }
                }
            }
            
            return points;
        }
        
        function loadTemplateFileFromInput() {
            const fileInput = document.getElementById('template-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ¨¡æ¿æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    templates = parseTemplateFile(content);
                    console.log('åŠ è½½çš„æ¨¡æ¿:', templates);
                    updateTemplateUI();
                    alert(`æˆåŠŸåŠ è½½ ${Object.keys(templates).length} ä¸ªæ¨¡æ¿`);
                    
                    try {
                        localStorage.setItem('fiveHoleTemplates', JSON.stringify(templates));
                    } catch (e) {
                        console.log('æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨');
                    }
                } catch (error) {
                    console.error('è§£ææ¨¡æ¿æ–‡ä»¶å¤±è´¥:', error);
                    alert('è§£ææ¨¡æ¿æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
            };
            
            reader.readAsText(file);
        }
        
        function loadTemplatesFromLocalStorage() {
            try {
                const saved = localStorage.getItem('fiveHoleTemplates');
                if (saved) {
                    templates = JSON.parse(saved);
                    updateTemplateUI();
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ¿æˆåŠŸ');
                    return true;
                }
            } catch (e) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ¿å¤±è´¥:', e);
            }
            return false;
        }
        
        async function loadTemplateFromGitHub() {
            showLoading(true);
            try {
                console.log('æ­£åœ¨ä»GitHubåŠ è½½æ¨¡æ¿æ–‡ä»¶...');
                
                // å°è¯•å¤šä¸ªå¯èƒ½çš„URL
                const possibleUrls = [
                    GITHUB_TEMPLATE_URL,
                    'https://github.com/Xiaowuyu273637/Five-hole-calculator/blob/main/Template%20Point.txt',
                ];
                
                let content = null;
                let successUrl = null;
                
                for (const url of possibleUrls) {
                    try {
                        console.log(`å°è¯•ä» ${url} åŠ è½½...`);
                        const response = await fetch(url);
                        if (response.ok) {
                            content = await response.text();
                            successUrl = url;
                            console.log(`ä» ${url} åŠ è½½æˆåŠŸ`);
                            break;
                        }
                    } catch (error) {
                        console.log(`ä» ${url} åŠ è½½å¤±è´¥:`, error.message);
                    }
                }
                
                if (!content) {
                    console.warn('æ— æ³•ä»GitHubåŠ è½½æ¨¡æ¿ï¼Œä½¿ç”¨å†…ç½®æ¨¡æ¿');
                    // ä½¿ç”¨å†…ç½®æ¨¡æ¿å†…å®¹
                    content = `ä¸»è½´24æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-25.5ï¼Œç¤ºä¾‹ç‚¹ï¼š24,-8.7 16.6,19.3 4,19.3 -18.3,17.8 -24,-8.7 -24,-8.7
120410å®šä½å­”ï¼š-35,0

ä¸‹è½´24æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-25.5ï¼Œç¤ºä¾‹ç‚¹ï¼š24,-8.7 18.7,17.8 -16.6,19.3 -24,-8.7
110010æ ‡è®°å­”ï¼š23.8,1.5

ä¸»è½´26.3æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-28.0ï¼Œç¤ºä¾‹ç‚¹ï¼š26.3,-9.6 18,21.4 -20.1,19.4 -26.3,-9.6
115010æ’æ°”å­”ï¼š15.3,-21.2 -18.6,-18.7
115010å®šä½å­”ï¼š-37,0
226110å®šä½å­”ï¼š20.6,-19 3.8,19.5 -28,1.3
228110æ’æ°”å­”ï¼š15.3,-21.2 -18.6,-18.7
222810æ’æ°”å­”ï¼š15.3,-21.2 -18.6,-18.7
229410æ’æ°”å­”ï¼š15.3,-21.2 -18.6,-18.7
229410å®šä½å­”ï¼š0,-38
235210å®šä½å­”ï¼š0,-38
241110å®šä½å­”ï¼š0,-38
ç¾çš„11105815å®šä½å­”ï¼š-37,0
115811å®šä½å­”ï¼š-37,0
243810å®šä½å­”ï¼š0,-38

ä¸‹è½´26.3æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-28.0ï¼Œç¤ºä¾‹ç‚¹ï¼š26.3,-9.6 20.1,19.4 -4,18.6 -18,21.4 -26.3,9.6
111810æ’æ°”å­”ï¼š18.6,-18.7 -15.3,-21.2 
111810æ²‰å­”ï¼š23.5,8.6 -20.4,-14.4
226110å®šä½å­”ï¼š20.6,-19 3.8,19.5 -28,1.3
224510æ’æ°”å­”ï¼š18.6,-18.7 -15.3,-21.3
224510æ’æ°”å­”ç²—é“£ï¼š-3.6,18.7
241010æ ‡è®°ç‚¹ï¼š-23.8,1.5
241910æ ‡è®°ç‚¹ï¼š-23.8,1.5
141310æ’æ°”å­”ï¼š15.3,-21.2 -18.6,-18.7
141310å®šä½å­”ï¼š-37,0
141310æ ‡è®°å­”ï¼š-22,5

ä¸»è½´27.7æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-29.5ï¼Œç¤ºä¾‹ç‚¹ï¼š27.7,-10.2 19,22.6 3.8,21 -21.5,20.2 -27.7,-10.2
223710æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
223710å®šä½å­”ï¼š0,-38
224610æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
224610å®šä½å­”ï¼š0,-38
227210æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
227210å®šä½å­”ï¼š0,-38
233310æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
233310å®šä½å­”ï¼š0,-38
224610æ’æ°”å­”ï¼š16.5,-23 -20,-20
224610å®šä½å­”ï¼š0,-38
242010æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
242010å®šä½å­”ï¼š0,-38
230210æ’æ°”å­”ï¼š16.5,-23 -20,-20
230210å®šä½å­”ï¼š0,-38
243110æ’æ°”å­”ï¼š15,-24.5 -15,-24.5
243110å®šä½å­”ï¼š0,-38
231910å®šä½å­”ï¼š0,-38
227811å®šä½å­”ï¼š0,-38
240911æ’æ°”å­”ï¼š13.2,-25.8 -20.5,-20.5
240911æ’æ°”å­”ï¼š13.2,-25.8 -29,0 -20.5,-20.5
è‹±ç»´å…‹L6151510æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
è‹±ç»´å…‹L6151510å®šä½å­”ï¼š0,-38

ä¸‹è½´27.7æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-29.5ï¼Œç¤ºä¾‹ç‚¹ï¼š27.7,-10.2 21.5,20.2 -3.8,21 -19,22.6 -27.7,-10.2
è‹±ç»´å…‹L6160510æ’æ°”å­”ï¼š16.5,-23.5 -16.5,-23.5
è‹±ç»´å…‹L6160110æ ‡è®°ç‚¹ï¼š-26,2
241310æ’æ°”å­”ï¼š15,-24.5 -15,-24.5
242210æ’æ°”å­”ï¼š16.5,-23 -16.5,-23
244910æ’æ°”å­”ï¼š16.5,-23 -16.5,-23
244910å®šä½å­”ï¼š0,-38

ä¸»è½´28.7æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-30.5 ç¤ºä¾‹ç‚¹ï¼š28.7,-10.4 19.6,23.4 4.6,22.8 -21.9,21.2 -28.7,-10.4
360110å®šä½å­”ï¼š17,-24.9 -35.5,-24.7
360410å®šä½å­”ï¼š17,-24.9 -35.5,-24.7
320210æ’æ°”å­”ï¼š16,-25.4 -35.5,-24.7 -16.1,25.4
320210å®šä½å­”ï¼š-35.5,-24.7
356720å®šä½å­”ï¼š-35.5,-24.7
356720æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4
354810å®šä½å­”ï¼š14.5,-43.6 39,22.5 -39,22.5
357010å®šä½å­”ï¼š-35.5,-24.7
357010æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4
357710å®šä½å­”ï¼š-35.5,-24.7
357710æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4
300210å®šä½å­”ï¼š-35.5,-24.7
300210æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4

ä¸‹è½´28.7æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-30.5ï¼Œç¤ºä¾‹ç‚¹ï¼š28.7,-10.4 21.2,21.9 -4.6,22.8 -19.6,23.4 -28.7,-10.4
352910æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4
353610æ’æ°”å­”ï¼š16.1,-25.4 -16.1,-25.4

ä¸»è½´33æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-35.0ï¼Œç¤ºä¾‹ç‚¹ï¼š33,-11 22,27 4.8,22.9 -24.4,25.1 -33,-11
390611å®šä½å­”ï¼š-38,-25.5
392310æ’æ°”å­”ï¼š18.3,-26.7 -18.7,-26.7
392310æ²‰å­”ï¼š-2.5,-47.4 42.3,21.6 -39.8,25.9
522010æ’æ°”å­”ï¼š20.3,-27.9 -33.4,8.3 -20.3,-27.9

ä¸‹è½´33æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-35.0ï¼Œç¤ºä¾‹ç‚¹ï¼š33,-11 24,25.3 -4.6,25.9 -22,27 -33,-11
521610æ’æ°”å­”ï¼š20.3,-27.9 33.4,8.3 -20.3,-27.9
522310æ’æ°”å­”ï¼š20.3,-27.9 33.4,8.3 -20.3,-27.9
522510æ’æ°”å­”ï¼š20.3,-27.9 -20.3,-27.9
522510æ²‰å­”ï¼š32,11.5 -27.8,-19.5
516820æ’æ°”å­”ï¼š20.3,-27.9 33.4,8.3 -20.3,-27.9
521710æ’æ°”å­”ï¼š20.3,-27.9 33.4,8.3 -20.3,-27.9

ä¸»è½´37.2æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-39.0ï¼Œç¤ºä¾‹ç‚¹ï¼š37.2,-11.9 24.4,30.4 4.8,26.3 -27.6,27.6 -37.2,-11.9
632710æ’æ°”å­”ï¼š22.5,-30.6 -22.5,-30.6
632710å®šä½å­”ï¼š4.8,26.3 -33,-43
631210æ’æ°”å­”ï¼š22.5,-30.6 -35.5,13.5 -22.5,-30.6
631210å®šä½å­”ï¼š4.8,26.3 -33,-43

ä¸»è½´38.1æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-40ï¼Œç¤ºä¾‹ç‚¹ï¼š38.1,-12.2 25.1,31.2 5.4,28 -28.3,28.3 -22.5,-30.6
712810æ’æ°”å­”ï¼š11.5,-36.2 22.5,-30.6 -38,6.5 -22.5,-30.6
712810å®šä½å­”ï¼š-12,-34 -33.3,-47.5

ç‰¹åˆ«ç‰ˆ28.7æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-30.5ï¼Œç¤ºä¾‹ç‚¹ï¼š16.1,-25.4 28.7,-10.4 21.2,21.9 -4.6,22.8 -19.6,23.4 -28.7,-10.4 -16.1,-25.4
338910æ²‰å­”ï¼š28,12.4 -24.5,-18.3
339110æ²‰å­”ï¼š28,12.4 -24.5,-18.3
392010å®šä½å­”ï¼š-35.5,-24.7
300210æ²‰å­”ï¼š28,12.4 -24.5,-18.3

ç‰¹åˆ«ç‰ˆ33æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-35.0ï¼Œç¤ºä¾‹ç‚¹ï¼š19,-27.7 33,-11 22,27 4.6,24.5 -24.4,25.1 -33,-11 -19,-27.7
392510å®šä½å­”ï¼š14,44.5 -35.5,-24.7

ä¸‹è½´ç‰¹åˆ«ç‰ˆ33æ¨¡ç‰ˆåŸç‚¹ï¼šX0,Y-35.0ï¼Œç¤ºä¾‹ç‚¹ï¼š19,-27.7 33,-11 24.4,25.1 -4.6,24.5 -22,27 -33,-11 -19,-27.7
300410æ²‰å­”ï¼š17.4,-25.3 -17.4,-25.3
300410æ²‰å­”2ï¼š32,14.2 -28,-20.9
338010æ²‰å­”ï¼š32,14.2 -28,-20.9
339810æ²‰å­”ï¼š17.4,-25.3 -17.4,-25.3
339810æ²‰å­”2ï¼š32,14.2 -28,-20.9`;
                }
                
                templates = parseTemplateFile(content);
                console.log(`æˆåŠŸè§£æ ${Object.keys(templates).length} ä¸ªæ¨¡æ¿`);
                
                updateTemplateUI();
                
                try {
                    localStorage.setItem('fiveHoleTemplates', JSON.stringify(templates));
                    console.log('æ¨¡æ¿å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                } catch (e) {
                    console.log('æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨');
                }
                
                showLoading(false);
                return true;
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿æ–‡ä»¶å¤±è´¥:', error);
                alert('åŠ è½½æ¨¡æ¿æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                showLoading(false);
                return false;
            }
        }
        
        function sortTemplateNames(templateNames, category) {
            if (category === 'é™„åŠ æ¨¡æ¿') {
                return templateNames.sort((a, b) => {
                    const numA = parseInt(a.match(/^(\d+)/)?.[1] || '999999');
                    const numB = parseInt(b.match(/^(\d+)/)?.[1] || '999999');
                    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    
                    if (!isNaN(numA) && isNaN(numB)) {
                        return -1;
                    }
                    
                    if (isNaN(numA) && !isNaN(numB)) {
                        return 1;
                    }
                    
                    const pinyinA = getFirstLetter(a);
                    const pinyinB = getFirstLetter(b);
                    
                    if (pinyinA && pinyinB) {
                        return pinyinA.localeCompare(pinyinB, 'zh-CN');
                    }
                    
                    return a.localeCompare(b, 'zh-CN');
                });
            }
            
            return templateNames.sort((a, b) => a.localeCompare(b, 'zh-CN'));
        }
        
        function getFirstLetter(str) {
            const brandMappings = {
                'ç¾çš„': 'M',
                'è‹±ç»´å…‹': 'Y',
                'æµ·å°”': 'H',
                'æ ¼åŠ›': 'G',
                'æµ·ä¿¡': 'H',
                'TCL': 'T',
                'å¥¥å…‹æ–¯': 'A'
            };
            
            for (const brand in brandMappings) {
                if (str.includes(brand)) {
                    return brandMappings[brand];
                }
            }
            
            const firstChar = str.charAt(0);
            const pinyinMap = {
                'ç¾': 'M', 'è‹±': 'Y', 'æµ·': 'H', 'æ ¼': 'G', 'å¥¥': 'A',
                'æ’': 'P', 'æ²‰': 'C', 'å®š': 'D', 'æ ‡': 'B', 'ç²—': 'C'
            };
            
            return pinyinMap[firstChar] || firstChar;
        }
        
        function updateTemplateUI() {
            const templateGroups = document.getElementById('template-groups');
            const templateSelect = document.getElementById('template-select');
            
            templateGroups.innerHTML = '';
            if (templateSelect) {
                templateSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡æ¿æ·»åŠ åˆ°ç»„åˆ</option>';
            }
            
            const categories = {};
            Object.keys(templates).forEach(templateName => {
                const template = templates[templateName];
                const category = template.category || 'å…¶ä»–æ¨¡æ¿';
                
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(templateName);
            });
            
            const categoryOrder = ['ä¸»è½´æ¨¡æ¿', 'ä¸‹è½´æ¨¡æ¿', 'ç‰¹åˆ«ç‰ˆæ¨¡æ¿', 'é™„åŠ æ¨¡æ¿', 'å…¶ä»–æ¨¡æ¿'];
            
            categoryOrder.forEach(category => {
                if (categories[category] && categories[category].length > 0) {
                    let templateNames = categories[category];
                    templateNames = sortTemplateNames(templateNames, category);
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'template-group collapsible';
                    
                    const isCollapsed = !templateGroupStates[category];
                    
                    groupDiv.innerHTML = `
                        <div class="template-group-header" onclick="toggleTemplateGroup('${category}')">
                            <h4>${category} (${templateNames.length}ä¸ª)</h4>
                            <span class="toggle-icon ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
                        </div>
                        <div class="template-group-content ${isCollapsed ? 'collapsed' : ''}" id="${category}-content">
                            ${category === 'é™„åŠ æ¨¡æ¿' ? `
                                <div class="template-search">
                                    <input type="text" id="${category}-search" placeholder="æœç´¢${category}..." oninput="filterTemplates('${category}', this.value)">
                                    <span class="search-icon">ğŸ”</span>
                                </div>
                            ` : ''}
                            <div class="template-buttons" id="${category}-buttons">
                                ${templateNames.map(name => 
                                    `<button onclick="loadTemplate('${name}', ${templates[name].origin ? 'true' : 'false'})">${name}</button>`
                                ).join('')}
                            </div>
                            <div id="${category}-not-found" class="template-not-found hidden">
                                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿
                            </div>
                        </div>
                    `;
                    templateGroups.appendChild(groupDiv);
                    
                    if (templateSelect) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = category;
                        templateNames.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            optgroup.appendChild(option);
                        });
                        templateSelect.appendChild(optgroup);
                    }
                }
            });
            
            const loadingDiv = document.getElementById('template-loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            // åˆå§‹åŒ–æœç´¢å…³é”®è¯
            categoryOrder.forEach(category => {
                if (category === 'é™„åŠ æ¨¡æ¿') {
                    searchKeywords[category] = '';
                }
            });
        }
        
        function toggleTemplateGroup(category) {
            const content = document.getElementById(`${category}-content`);
            const toggleIcon = content.previousElementSibling.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggleIcon.classList.remove('collapsed');
                templateGroupStates[category] = true;
            } else {
                content.classList.add('collapsed');
                toggleIcon.classList.add('collapsed');
                templateGroupStates[category] = false;
            }
        }
        
        function filterTemplates(category, keyword) {
            searchKeywords[category] = keyword.toLowerCase();
            
            const buttonsContainer = document.getElementById(`${category}-buttons`);
            const notFoundDiv = document.getElementById(`${category}-not-found`);
            const buttons = buttonsContainer.querySelectorAll('button');
            
            let visibleCount = 0;
            
            buttons.forEach(button => {
                const templateName = button.textContent.toLowerCase();
                if (keyword === '' || templateName.includes(keyword.toLowerCase())) {
                    button.style.display = '';
                    visibleCount++;
                } else {
                    button.style.display = 'none';
                }
            });
            
            if (visibleCount === 0 && keyword !== '') {
                notFoundDiv.classList.remove('hidden');
            } else {
                notFoundDiv.classList.add('hidden');
            }
        }
        
        // ========== é€’å¢è®¡ç®—å™¨å‡½æ•° ==========
        function calculateStandardValues() {
            if (!incrementalSelectedTemplate) {
                standardXValue = 0;
                standardCValue = 0;
                return;
            }
            
            const programText = document.getElementById('programContent').textContent;
            if (!programText || programText.includes('æš‚æ— ç¨‹åºæ•°æ®')) {
                standardXValue = 0;
                standardCValue = 0;
                return;
            }
            
            const programPoints = parseProgramPoints(programText);
            if (programPoints.length === 0) {
                standardXValue = 0;
                standardCValue = 0;
                return;
            }
            
            if (isCombinationMode && selectedTemplates.length > 0) {
                const templateIndex = selectedTemplates.indexOf(incrementalSelectedTemplate);
                if (templateIndex !== -1) {
                    let startPoint = 0;
                    for (let i = 0; i < templateIndex; i++) {
                        const tplName = selectedTemplates[i];
                        const tpl = templates[tplName];
                        if (tpl) {
                            startPoint += tpl.points.length;
                        }
                    }
                    
                    const template = templates[incrementalSelectedTemplate];
                    if (template) {
                        if (startPoint < programPoints.length) {
                            standardXValue = programPoints[startPoint].x;
                            standardCValue = programPoints[startPoint].c;
                        } else {
                            standardXValue = programPoints[0].x;
                            standardCValue = programPoints[0].c;
                        }
                    }
                } else {
                    standardXValue = programPoints[0].x;
                    standardCValue = programPoints[0].c;
                }
            } else {
                standardXValue = programPoints[0].x;
                standardCValue = programPoints[0].c;
            }
            
            console.log('æ ‡å‡†å€¼è®¡ç®—:', {
                template: incrementalSelectedTemplate,
                isCombinationMode: isCombinationMode,
                standardXValue: standardXValue,
                standardCValue: standardCValue,
                programPointsCount: programPoints.length
            });
        }
        
        function parseProgramPoints(programText) {
            const lines = programText.split('\n');
            const points = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('X') && line.includes('C')) {
                    const match = line.match(/X([-\d.]+)C([-\d.]+)/);
                    if (match) {
                        const xValue = parseFloat(match[1]);
                        const cValue = parseFloat(match[2]);
                        points.push({ x: xValue, c: cValue });
                    }
                }
            });
            
            return points;
        }
        
        function showStandardValueInfo() {
            const infoDiv = document.getElementById('standardValueHighlight');
            
            if (incrementalSelectedTemplate) {
                infoDiv.innerHTML = `
                    <h4>æ ‡å‡†å€¼ä¿¡æ¯</h4>
                    <div class="standard-values">
                        <div class="standard-value-item">
                            <div class="label">æ ‡å‡†Xå€¼</div>
                            <div class="value" id="standardXValueDisplay">${standardXValue.toFixed(2)}</div>
                        </div>
                        <div class="standard-value-item">
                            <div class="label">æ ‡å‡†Cå€¼</div>
                            <div class="value" id="standardCValueDisplay">${standardCValue.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                        æ³¨ï¼šæ ‡å‡†å€¼ä¸ºç¨‹åºä¸­ç¬¬ä¸€ä¸ªç‚¹çš„Xå’ŒCå€¼
                    </div>
                `;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        function updateIncrementalDisplay() {
            if (!incrementalSelectedTemplate) {
                clearIncrementalInputs();
                return;
            }
            
            document.getElementById('standardXValue').textContent = standardXValue.toFixed(2);
            document.getElementById('standardCValue').textContent = standardCValue.toFixed(2);
            
            const standardXDisplay = document.getElementById('standardXValueDisplay');
            const standardCDisplay = document.getElementById('standardCValueDisplay');
            if (standardXDisplay) standardXDisplay.textContent = standardXValue.toFixed(2);
            if (standardCDisplay) standardCDisplay.textContent = standardCValue.toFixed(2);
            
            calculateAdjustedValues();
        }
        
        function clearIncrementalInputs() {
            document.getElementById('standardXValue').textContent = '--';
            document.getElementById('standardCValue').textContent = '0.00';
            document.getElementById('adjustedXValue').textContent = '--';
            document.getElementById('adjustedCValue').textContent = '0.00';
            
            document.getElementById('xAdjustment').value = '0.00';
            document.getElementById('cAdjustment').value = '0.00';
        }
        
        function calculateAdjustedValues() {
            xAdjustment = parseFloat(document.getElementById('xAdjustment').value) || 0;
            cAdjustment = parseFloat(document.getElementById('cAdjustment').value) || 0;
            
            const adjustedX = standardXValue + xAdjustment;
            const adjustedC = standardCValue + cAdjustment;
            
            document.getElementById('adjustedXValue').textContent = adjustedX.toFixed(2);
            document.getElementById('adjustedCValue').textContent = adjustedC.toFixed(2);
        }
        
        function applyAdjustments() {
            if (!incrementalSelectedTemplate) {
                alert("è¯·å…ˆé€‰æ‹©æ¨¡æ¿");
                return;
            }
            
            xAdjustment = parseFloat(document.getElementById('xAdjustment').value) || 0;
            cAdjustment = parseFloat(document.getElementById('cAdjustment').value) || 0;
            
            calculateAdjustedProgram();
            
            if (xAdjustment !== 0 || cAdjustment !== 0) {
                let msg = "è°ƒæ•´å·²åº”ç”¨ï¼š\n";
                if (xAdjustment !== 0) msg += `Xå€¼è°ƒæ•´ï¼š${xAdjustment > 0 ? '+' : ''}${xAdjustment.toFixed(2)}mm\n`;
                if (cAdjustment !== 0) msg += `Cå€¼è°ƒæ•´ï¼š${cAdjustment > 0 ? '+' : ''}${cAdjustment.toFixed(2)}Â°`;
                console.log(msg);
            }
        }
        
        function resetAdjustments() {
            document.getElementById('xAdjustment').value = '0.00';
            document.getElementById('cAdjustment').value = '0.00';
            
            xAdjustment = 0;
            cAdjustment = 0;
            
            calculateAdjustedValues();
            calculateAdjustedProgram();
        }
        
        function calculateAdjustedProgram() {
            if (incrementalSelectedTemplate) {
                calculateStandardValues();
                updateIncrementalDisplay();
            }
            
            const programText = document.getElementById('programContent').textContent;
            if (programText.includes('æš‚æ— ç¨‹åºæ•°æ®')) {
                document.getElementById('adjustedProgramContent').textContent = "è¯·å…ˆåœ¨äº”å­”è®¡ç®—å™¨ä¸­ç”Ÿæˆç¨‹åº";
                return;
            }
            
            const originalPoints = parseProgramPoints(programText);
            if (originalPoints.length === 0) {
                document.getElementById('adjustedProgramContent').textContent = "æ— æ³•è§£æåŸå§‹ç¨‹åº";
                return;
            }
            
            xAdjustment = parseFloat(document.getElementById('xAdjustment').value) || 0;
            cAdjustment = parseFloat(document.getElementById('cAdjustment').value) || 0;
            
            const adjustedProgram = generateAdjustedProgram(programText, originalPoints);
            document.getElementById('adjustedProgramContent').textContent = adjustedProgram;
            
            updateComparisonTable(originalPoints, adjustedProgram);
            
            console.log('ç¨‹åºè°ƒæ•´è®¡ç®—å®Œæˆ:', {
                originalPoints: originalPoints.length,
                xAdjustment: xAdjustment,
                cAdjustment: cAdjustment,
                adjustedProgramLength: adjustedProgram.length
            });
        }
        
        function generateAdjustedProgram(originalProgram, originalPoints) {
            const lines = originalProgram.split('\n');
            let adjustedLines = [];
            let pointIndex = 0;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('X') && trimmedLine.includes('C')) {
                    if (pointIndex < originalPoints.length) {
                        const adjustedX = originalPoints[pointIndex].x + xAdjustment;
                        const adjustedC = originalPoints[pointIndex].c + cAdjustment;
                        
                        adjustedLines.push(`X${adjustedX.toFixed(2)}C${adjustedC.toFixed(2)}`);
                        pointIndex++;
                    } else {
                        adjustedLines.push(line);
                    }
                } else {
                    adjustedLines.push(line);
                }
            });
            
            return adjustedLines.join('\n');
        }
        
        function updateComparisonTable(originalPoints, adjustedProgram) {
            const tableBody = document.getElementById('comparisonTableBody');
            tableBody.innerHTML = '';
            
            if (originalPoints.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            æš‚æ— æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }
            
            const adjustedLines = adjustedProgram.split('\n');
            const adjustedPoints = [];
            
            adjustedLines.forEach(line => {
                line = line.trim();
                if (line.startsWith('X') && line.includes('C')) {
                    const match = line.match(/X([-\d.]+)C([-\d.]+)/);
                    if (match) {
                        const xValue = parseFloat(match[1]);
                        const cValue = parseFloat(match[2]);
                        adjustedPoints.push({ x: xValue, c: cValue });
                    }
                }
            });
            
            for (let i = 0; i < originalPoints.length; i++) {
                const original = originalPoints[i];
                const adjusted = adjustedPoints[i] || { x: 0, c: 0 };
                
                const xDiff = adjusted.x - original.x;
                const cDiff = adjusted.c - original.c;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td class="original-value">${original.x.toFixed(2)}</td>
                    <td class="adjusted-value">${adjusted.x.toFixed(2)}</td>
                    <td class="difference">${xDiff > 0 ? '+' : ''}${xDiff.toFixed(2)}</td>
                    <td class="original-value">${original.c.toFixed(2)}</td>
                    <td class="adjusted-value">${adjusted.c.toFixed(2)}</td>
                    <td class="difference">${cDiff > 0 ? '+' : ''}${cDiff.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        function exportAdjustedProgram() {
            const adjustedProgram = document.getElementById('adjustedProgramContent').textContent;
            
            if (adjustedProgram.includes('æš‚æ— ç¨‹åºæ•°æ®') || adjustedProgram.includes('æ— æ³•è§£æ') || 
                adjustedProgram.includes('è¯·å…ˆé€‰æ‹©')) {
                alert("è¯·å…ˆç”Ÿæˆè°ƒæ•´åçš„ç¨‹åº");
                return;
            }
            
            openProgramNameModal();
            
            const originalExport = window.exportProgram;
            window.exportProgram = function() {
                const programName = document.getElementById('programName').value.trim();
                
                if (!programName) {
                    alert("è¯·è¾“å…¥ç¨‹åºåç§°");
                    document.getElementById('programName').focus();
                    return;
                }

                showLoading(true);
                
                setTimeout(() => {
                    try {
                        const programContent = document.getElementById('adjustedProgramContent').textContent;
                        
                        const blob = new Blob([programContent], { 
                            type: 'text/plain;charset=utf-8' 
                        });
                        
                        const link = document.createElement('a');
                        link.download = programName;
                        link.href = URL.createObjectURL(blob);
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        URL.revokeObjectURL(link.href);
                        
                        closeProgramNameModal();
                        
                        alert(`è°ƒæ•´åçš„ç¨‹åºæ–‡ä»¶ "${programName}" å¯¼å‡ºæˆåŠŸï¼`);
                        
                        window.exportProgram = originalExport;
                        
                    } catch (error) {
                        alert('å¯¼å‡ºç¨‹åºå¤±è´¥ï¼š' + error.message);
                    } finally {
                        showLoading(false);
                    }
                }, 100);
            };
            
            document.getElementById('programName').value = "è°ƒæ•´åçš„ç¨‹åº";
        }
        
        // ========== ç¨‹åºç›¸å…³å‡½æ•° ==========
        function switchFormat(format) {
            currentFormat = format;
            
            document.getElementById('format1Btn').classList.toggle('active', format === 1);
            document.getElementById('format2Btn').classList.toggle('active', format === 2);
            
            updateProgramDisplay();
            
            calculateAdjustedProgram();
        }
        
        function openProgramNameModal() {
            const modal = document.getElementById('programNameModal');
            modal.classList.add('active');
            document.getElementById('programName').focus();
            document.getElementById('programName').value = '';
        }
        
        function closeProgramNameModal() {
            document.getElementById('programNameModal').classList.remove('active');
            document.getElementById('programName').value = '';
        }
        
        function exportProgram() {
            const programName = document.getElementById('programName').value.trim();
            
            if (!programName) {
                alert("è¯·è¾“å…¥ç¨‹åºåç§°");
                document.getElementById('programName').focus();
                return;
            }

            showLoading(true);
            
            setTimeout(() => {
                try {
                    const programContent = document.getElementById('programContent').textContent;
                    
                    const blob = new Blob([programContent], { 
                        type: 'text/plain;charset=utf-8' 
                    });
                    
                    const link = document.createElement('a');
                    link.download = programName;
                    link.href = URL.createObjectURL(blob);
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(link.href);
                    
                    closeProgramNameModal();
                    
                    alert(`ç¨‹åºæ–‡ä»¶ "${programName}" å¯¼å‡ºæˆåŠŸï¼`);
                    
                } catch (error) {
                    alert('å¯¼å‡ºç¨‹åºå¤±è´¥ï¼š' + error.message);
                } finally {
                    showLoading(false);
                }
            }, 100);
        }
        
        function isAdditionalTemplate(templateName) {
            const template = templates[templateName];
            return template && (!template.origin || template.category === 'é™„åŠ æ¨¡æ¿');
        }
        
        function updateProgramDisplay() {
            const programContent = generateProgram();
            document.getElementById('programContent').textContent = programContent;
            
            if (incrementalSelectedTemplate) {
                calculateStandardValues();
                updateIncrementalDisplay();
                showStandardValueInfo();
            }
            
            calculateAdjustedProgram();
        }
        
        function generateProgram() {
            if (calculatedResults.length === 0 || points.length === 0) {
                return "æš‚æ— ç¨‹åºæ•°æ®ï¼Œè¯·å…ˆåŠ è½½æ¨¡æ¿æˆ–æ·»åŠ ç‚¹ã€‚";
            }
            
            let program = "";
            
            const currentTemplateName = selectedTemplates.length > 0 ? selectedTemplates[0] : '';
            const isAdditional = isAdditionalTemplate(currentTemplateName);
            
            const startDistance = calculateDistance(O, A);
            const startDiameter = (startDistance * 2).toFixed(2);
            
            const generateStandardProgram = () => {
                let prog = `$1\n`;
                prog += `T0\n`;
                prog += `G0Z50.0\n`;
                prog += `X${startDiameter}C0.0\n`;
                prog += `Z2.0\n`;
                prog += `G83Z-15.3R2.0F300\n`;
                
                if (isCombinationMode) {
                    let pointIndex = 0;
                    
                    for (let templateIndex = 0; templateIndex < selectedTemplates.length; templateIndex++) {
                        const templateName = selectedTemplates[templateIndex];
                        const template = templates[templateName];
                        if (!template) continue;
                        
                        const templatePoints = template.points;
                        const isTemplateAdditional = isAdditionalTemplate(templateName);
                        
                        if (isTemplateAdditional) {
                            for (let i = 0; i < templatePoints.length; i++) {
                                const point = templatePoints[i];
                                const distanceToCenter = calculateDistance(O, point);
                                const diameter = (distanceToCenter * 2).toFixed(2);
                                
                                let angle;
                                if (i === 0) {
                                    angle = calculateSectorAngle(O, A, point);
                                } else {
                                    const prevPoint = templatePoints[i-1];
                                    angle = calculateSectorAngle(O, prevPoint, point);
                                    
                                    if (Math.abs(angle) < 5) {
                                        angle = -angle;
                                    }
                                }
                                
                                prog += `X${diameter}C${angle.toFixed(2)}\n`;
                            }
                        } else {
                            let cumulativeAngle = 0;
                            for (let i = 0; i < templatePoints.length; i++) {
                                const point = templatePoints[i];
                                const distanceToCenter = calculateDistance(O, point);
                                const diameter = (distanceToCenter * 2).toFixed(2);
                                
                                const resultIndex = pointIndex + i;
                                if (resultIndex < calculatedResults.length) {
                                    cumulativeAngle += parseFloat(calculatedResults[resultIndex].angle);
                                }
                                
                                prog += `X${diameter}C${cumulativeAngle.toFixed(2)}\n`;
                            }
                        }
                        
                        pointIndex += templatePoints.length;
                    }
                } else if (isAdditional) {
                    for (let i = 0; i < points.length; i++) {
                        const point = points[i];
                        const distanceToCenter = calculateDistance(O, point);
                        const diameter = (distanceToCenter * 2).toFixed(2);
                        
                        let angle;
                        if (i === 0) {
                            angle = calculateSectorAngle(O, A, point);
                        } else {
                            const prevPoint = points[i-1];
                            angle = calculateSectorAngle(O, prevPoint, point);
                            
                            if (Math.abs(angle) < 5) {
                                angle = -angle;
                            }
                        }
                        
                        prog += `X${diameter}C${angle.toFixed(2)}\n`;
                    }
                } else {
                    let cumulativeAngle = 0;
                    for (let i = 0; i < points.length; i++) {
                        const point = points[i];
                        const distanceToCenter = calculateDistance(O, point);
                        const diameter = (distanceToCenter * 2).toFixed(2);
                        
                        if (i < calculatedResults.length) {
                            cumulativeAngle += parseFloat(calculatedResults[i].angle);
                        }
                        
                        prog += `X${diameter}C${cumulativeAngle.toFixed(2)}\n`;
                    }
                }
                
                prog += `G0Z50.0\nM30\n`;
                
                return prog;
            };
            
            if (currentFormat === 1) {
                program = generateStandardProgram();
                
            } else if (currentFormat === 2) {
                const program1 = generateStandardProgram();
                program = program1 + "\n$2\n";
            }
            
            return program;
        }
        
        // ========== æ¨¡æ¿åº“å‡½æ•°ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰ ==========
        function toggleTemplatePanel() {
            const panel = document.getElementById('templatePanel');
            const overlay = document.getElementById('templateOverlay');
            
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            } else {
                panel.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeTemplatePanel() {
            const panel = document.getElementById('templatePanel');
            const overlay = document.getElementById('templateOverlay');
            
            panel.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function switchTab(tabNumber) {
            document.getElementById('tab1').classList.toggle('active', tabNumber === 1);
            document.getElementById('tab2').classList.toggle('active', tabNumber === 2);
            
            document.getElementById('calculator-tab').classList.toggle('active', tabNumber === 1);
            document.getElementById('incremental-tab').classList.toggle('active', tabNumber === 2);
            
            // åˆ‡æ¢æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨å…³é—­æ¨¡æ¿åº“
            closeTemplatePanel();
            
            if (tabNumber === 2) {
                calculateAdjustedProgram();
            }
        }
        
        function loadTemplate(templateName, replaceOrigin) {
            if (templates[templateName]) {
                const template = templates[templateName];
                
                isCombinationMode = false;
                selectedTemplates = [templateName];
                updateSelectedTemplatesDisplay();
                
                if (replaceOrigin && template.origin) {
                    A.x = template.origin.x;
                    A.y = template.origin.y;
                    document.getElementById('startX').value = A.x;
                    document.getElementById('startY').value = A.y;
                    product = Math.abs(A.y) * 2;
                    
                    points = [...template.points];
                } else {
                    points = [...template.points];
                }
                
                updatePointsDisplay();
                calculateAll();
                
                // æ›´æ–°é€’å¢è®¡ç®—å™¨çš„æ¨¡æ¿é€‰æ‹©
                incrementalSelectedTemplate = templateName;
                document.getElementById('templateInfoText').textContent = templateName;
                calculateStandardValues();
                updateIncrementalDisplay();
                showStandardValueInfo();
                
                // æ›´æ–°è°ƒæ•´å€¼æ˜¾ç¤º
                resetAdjustments();
                
                // å…³é—­æ¨¡æ¿åº“
                closeTemplatePanel();
                
                // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
                if (isMobile && navigator.vibrate) {
                    navigator.vibrate(100);
                }
            } else {
                alert(`æœªæ‰¾åˆ°æ¨¡æ¿: ${templateName}`);
            }
        }
        
        function addTemplateToCombination() {
            const templateSelect = document.getElementById('template-select');
            const templateName = templateSelect.value;
            
            if (!templateName) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿");
                return;
            }
            
            if (!templates[templateName]) {
                alert("é€‰æ‹©çš„æ¨¡æ¿ä¸å­˜åœ¨");
                return;
            }
            
            if (selectedTemplates.includes(templateName)) {
                alert("è¯¥æ¨¡æ¿å·²æ·»åŠ åˆ°ç»„åˆä¸­");
                return;
            }
            
            selectedTemplates.push(templateName);
            updateSelectedTemplatesDisplay();
            
            templateSelect.value = "";
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        function removeTemplateFromCombination(index) {
            selectedTemplates.splice(index, 1);
            updateSelectedTemplatesDisplay();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        function updateSelectedTemplatesDisplay() {
            const container = document.getElementById('selected-templates');
            
            if (selectedTemplates.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 10px;">æš‚æ— é€‰æ‹©çš„æ¨¡æ¿</div>';
                return;
            }
            
            let html = '';
            selectedTemplates.forEach((templateName, index) => {
                html += `
                    <div class="selected-template-item">
                        <span>${templateName}</span>
                        <button onclick="removeTemplateFromCombination(${index})" class="btn-red" style="padding: 8px 12px; font-size: 0.8em;">ç§»é™¤</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function clearTemplateCombination() {
            selectedTemplates = [];
            updateSelectedTemplatesDisplay();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        function loadMultiTemplateCombination() {
            if (selectedTemplates.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿");
                return;
            }
            
            isCombinationMode = true;
            
            let combinedOrigin = { x: 0, y: -35 };
            if (templates[selectedTemplates[0]] && templates[selectedTemplates[0]].origin) {
                combinedOrigin = { ...templates[selectedTemplates[0]].origin };
            }
            
            A.x = combinedOrigin.x;
            A.y = combinedOrigin.y;
            document.getElementById('startX').value = A.x;
            document.getElementById('startY').value = A.y;
            product = Math.abs(A.y) * 2;
            
            points = [];
            templatePointGroups = [];
            selectedTemplates.forEach(templateName => {
                if (templates[templateName]) {
                    const templatePoints = templates[templateName].points;
                    points = points.concat(templatePoints);
                    templatePointGroups.push({
                        name: templateName,
                        points: templatePoints,
                        isAdditional: isAdditionalTemplate(templateName)
                    });
                }
            });
            
            updatePointsDisplay();
            calculateAll();
            
            // æ›´æ–°é€’å¢è®¡ç®—å™¨çš„æ¨¡æ¿é€‰æ‹©
            if (selectedTemplates.length === 1) {
                incrementalSelectedTemplate = selectedTemplates[0];
                document.getElementById('templateInfoText').textContent = incrementalSelectedTemplate;
                calculateStandardValues();
                updateIncrementalDisplay();
                showStandardValueInfo();
            } else {
                incrementalSelectedTemplate = null;
                document.getElementById('templateInfoText').textContent = "å¤šæ¨¡æ¿ç»„åˆ";
                clearIncrementalInputs();
                document.getElementById('standardValueHighlight').style.display = 'none';
            }
            
            // å…³é—­æ¨¡æ¿åº“
            closeTemplatePanel();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(100);
            }
        }
        
        // ========== ç”»å¸ƒç›¸å…³å‡½æ•° ==========
        let canvas, ctx;
        
        function initCanvas() {
            canvas = document.getElementById('diagram');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = Math.min(400, window.innerHeight * 0.5);
            
            if (points.length > 0) calculateAll();
        }
        
        // ========== ç‚¹ç®¡ç†å‡½æ•° ==========
        function updateStartPoint() {
            const startX = parseFloat(document.getElementById('startX').value);
            const startY = parseFloat(document.getElementById('startY').value);
            
            if (!isNaN(startX)) A.x = startX;
            if (!isNaN(startY)) {
                A.y = startY;
                product = Math.abs(A.y) * 2;
            }
            
            calculateAll();
        }
        
        function addPoint() {
            const x = parseFloat(document.getElementById('newX').value);
            const y = parseFloat(document.getElementById('newY').value);
            
            if (isNaN(x) || isNaN(y)) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆåæ ‡");
                return;
            }
            
            points.push({ x, y });
            updatePointsDisplay();
            calculateAll();
            
            document.getElementById('newX').value = '';
            document.getElementById('newY').value = '';
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        function updatePointsDisplay() {
            const container = document.getElementById('points-container');
            container.innerHTML = '';
            
            points.forEach((point, index) => {
                const div = document.createElement('div');
                div.className = 'point-item';
                
                let pointLabel = `ç‚¹ ${index + 1}`;
                if (isCombinationMode) {
                    let templateIndex = 0;
                    let pointCount = 0;
                    
                    for (let i = 0; i < selectedTemplates.length; i++) {
                        const templateName = selectedTemplates[i];
                        const templatePoints = templates[templateName]?.points || [];
                        
                        if (index < pointCount + templatePoints.length) {
                            templateIndex = i;
                            break;
                        }
                        pointCount += templatePoints.length;
                    }
                    
                    pointLabel = `ç‚¹ ${templateIndex + 1}-${index - pointCount + 1}`;
                }
                
                div.innerHTML = `
                    <span>${pointLabel}:</span>
                    <input type="number" value="${point.x}" onchange="updatePoint(${index}, 'x', this.value)" step="0.1" inputmode="decimal">
                    <input type="number" value="${point.y}" onchange="updatePoint(${index}, 'y', this.value)" step="0.1" inputmode="decimal">
                    <button onclick="removePoint(${index})" class="btn-red">åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
        }
        
        function updatePoint(index, coord, value) {
            const num = parseFloat(value);
            if (!isNaN(num)) {
                points[index][coord] = num;
                calculateAll();
            }
        }
        
        function removePoint(index) {
            points.splice(index, 1);
            updatePointsDisplay();
            calculateAll();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        function clearAll() {
            points = [];
            isCombinationMode = false;
            selectedTemplates = [];
            templatePointGroups = [];
            updateSelectedTemplatesDisplay();
            updatePointsDisplay();
            document.querySelector('#result-table tbody').innerHTML = '';
            clearCanvas();
            calculatedResults = [];
            updateProgramDisplay();
            calculateAdjustedProgram();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(100);
            }
        }
        
        function clearCanvas() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function toggleCanvas() {
            canvasVisible = !canvasVisible;
            canvas.style.display = canvasVisible ? 'block' : 'none';
            document.getElementById('toggleCanvasBtn').textContent = 
                canvasVisible ? 'éšè—å›¾å½¢' : 'æ˜¾ç¤ºå›¾å½¢';
            
            if (canvasVisible) {
                resizeCanvas();
            }
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        function reversePoints() {
            points.reverse();
            updatePointsDisplay();
            calculateAll();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // ========== è®¡ç®—å‡½æ•° ==========
        function calculateDistance(point1, point2) {
            const dx = point2.x - point1.x;
            const dy = point2.y - point1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        function calculateDiameter(distance) {
            const rawDiameter = distance * 2;
            const roundedDiameter = Math.round(rawDiameter * 100) / 100;
            return roundedDiameter.toFixed(2);
        }
        
        function calculateAll() {
            if (points.length === 0) {
                clearCanvas();
                updateProgramDisplay();
                calculateAdjustedProgram();
                return;
            }
            
            calculatedResults = [];
            let prevPoint = A;
            
            if (isCombinationMode) {
                let pointCount = 0;
                
                for (let templateIndex = 0; templateIndex < selectedTemplates.length; templateIndex++) {
                    const templateName = selectedTemplates[templateIndex];
                    const template = templates[templateName];
                    if (!template) continue;
                    
                    const templatePoints = template.points;
                    const isTemplateAdditional = isAdditionalTemplate(templateName);
                    
                    if (isTemplateAdditional) {
                        for (let i = 0; i < templatePoints.length; i++) {
                            const point = templatePoints[i];
                            const distance = calculateDistance(O, point);
                            const diameter = calculateDiameter(distance);
                            
                            let angle;
                            if (i === 0) {
                                angle = calculateSectorAngle(O, A, point);
                            } else {
                                const prevTemplatePoint = templatePoints[i-1];
                                angle = calculateSectorAngle(O, prevTemplatePoint, point);
                            }
                            
                            calculatedResults.push({
                                name: `ç‚¹ ${templateIndex + 1}-${i + 1}`,
                                start: { ...prevPoint },
                                end: { ...point },
                                distance: distance.toFixed(2),
                                angle: angle.toFixed(2),
                                diameter: diameter
                            });
                            
                            prevPoint = point;
                        }
                    } else {
                        for (let i = 0; i < templatePoints.length; i++) {
                            const point = templatePoints[i];
                            const angle = calculateSectorAngle(O, prevPoint, point);
                            const distance = calculateDistance(O, point);
                            const diameter = calculateDiameter(distance);
                            
                            calculatedResults.push({
                                name: `æ‰‡å½¢ ${templateIndex + 1}-${i + 1}`,
                                start: { ...prevPoint },
                                end: { ...point },
                                distance: distance.toFixed(2),
                                angle: angle.toFixed(2),
                                diameter: diameter
                            });
                            
                            prevPoint = point;
                        }
                    }
                    
                    pointCount += templatePoints.length;
                }
                
                const finalAngle = calculateSectorAngle(O, prevPoint, A);
                const startDistance = calculateDistance(O, A);
                const finalDiameter = calculateDiameter(startDistance);
                
                calculatedResults.push({
                    name: `é—­åˆ`,
                    start: { ...prevPoint },
                    end: { ...A },
                    distance: startDistance.toFixed(2),
                    angle: finalAngle.toFixed(2),
                    diameter: finalDiameter
                });
                
            } else {
                const startDistance = calculateDistance(O, A);
                
                points.forEach((point, index) => {
                    const angle = calculateSectorAngle(O, prevPoint, point);
                    const distance = calculateDistance(O, point);
                    const diameter = calculateDiameter(distance);
                    
                    calculatedResults.push({
                        name: `æ‰‡å½¢ ${index + 1}`,
                        start: { ...prevPoint },
                        end: { ...point },
                        distance: distance.toFixed(2),
                        angle: angle.toFixed(2),
                        diameter: diameter
                    });
                    
                    prevPoint = point;
                });
                
                const finalAngle = calculateSectorAngle(O, prevPoint, A);
                const finalDiameter = calculateDiameter(startDistance);
                
                calculatedResults.push({
                    name: `æ‰‡å½¢ ${points.length + 1}`,
                    start: { ...prevPoint },
                    end: { ...A },
                    distance: startDistance.toFixed(2),
                    angle: finalAngle.toFixed(2),
                    diameter: finalDiameter
                });
            }
            
            updateResultsTable(calculatedResults);
            if (canvasVisible) drawDiagram(calculatedResults);
            updateProgramDisplay();
            calculateAdjustedProgram();
            
            // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(30);
            }
        }
        
        function calculateSectorAngle(O, A, B) {
            const oaX = A.x - O.x;
            const oaY = A.y - O.y;
            
            const obX = B.x - O.x;
            const obY = B.y - O.y;
            
            const dotProduct = oaX * obX + oaY * obY;
            
            const magnitudeOA = Math.sqrt(oaX * oaX + oaY * oaY);
            const magnitudeOB = Math.sqrt(obX * obX + obY * obY);
            
            const cosTheta = dotProduct / (magnitudeOA * magnitudeOB);
            const angleRad = Math.acos(Math.min(Math.max(cosTheta, -1), 1));
            
            return angleRad * 180 / Math.PI;
        }
        
        function updateResultsTable(results) {
            const tbody = document.querySelector('#result-table tbody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${result.name}</td>
                    <td>(${result.start.x.toFixed(2)}, ${result.start.y.toFixed(2)})</td>
                    <td>(${result.end.x.toFixed(2)}, ${result.end.y.toFixed(2)})</td>
                    <td>${result.distance}</td>
                    <td>${result.angle}</td>
                    <td>${result.diameter}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function drawDiagram(results) {
            clearCanvas();
            
            const allPoints = [O, A, ...points];
            const { scale, offsetX, offsetY } = calculateViewport(allPoints);
            
            const toCanvas = (x, y) => ({
                x: x * scale + offsetX,
                y: canvas.height - (y * scale + offsetY)
            });
            
            drawAxes(scale, offsetX, offsetY);
            
            results.forEach((result, index) => {
                const start = result.start;
                const end = result.end;
                
                const oCanvas = toCanvas(O.x, O.y);
                const startCanvas = toCanvas(start.x, start.y);
                const endCanvas = toCanvas(end.x, end.y);
                
                ctx.beginPath();
                ctx.moveTo(oCanvas.x, oCanvas.y);
                ctx.lineTo(startCanvas.x, startCanvas.y);
                
                const radius = Math.sqrt((startCanvas.x-oCanvas.x)**2 + (startCanvas.y-oCanvas.y)**2);
                
                const startAngle = Math.atan2(startCanvas.y-oCanvas.y, startCanvas.x-oCanvas.x);
                const endAngle = Math.atan2(endCanvas.y-oCanvas.y, endCanvas.x-oCanvas.x);
                
                ctx.arc(oCanvas.x, oCanvas.y, radius, startAngle, endAngle);
                ctx.lineTo(oCanvas.x, oCanvas.y);
                
                // ä½¿ç”¨å›ºå®šçš„é¢œè‰²ï¼Œä¸ä¾èµ–CSSå˜é‡
                const colors = ['#4285f4', '#0f9d58', '#ea4335', '#ff9800', '#9c27b0'];
                ctx.strokeStyle = colors[index % colors.length];
                ctx.lineWidth = 2;
                ctx.stroke();
                
                const midAngle = (startAngle + endAngle) / 2;
                const labelRadius = radius * 0.5;
                
                // è·å–å½“å‰ä¸»é¢˜çš„æ–‡å­—é¢œè‰²
                const currentTheme = document.body.getAttribute('data-theme');
                const textColor = currentTheme === 'dark' ? '#e0e0e0' : '#333333';
                
                ctx.fillStyle = textColor;
                ctx.font = '12px Arial';
                ctx.fillText(
                    `${result.angle}Â°`,
                    oCanvas.x + Math.cos(midAngle) * labelRadius,
                    oCanvas.y + Math.sin(midAngle) * labelRadius
                );
            });
            
            function drawPoint(x, y, label, color, size = 4) {
                const p = toCanvas(x, y);
                ctx.beginPath();
                ctx.arc(p.x, p.y, size, 0, Math.PI*2);
                ctx.fillStyle = color;
                ctx.fill();
                
                // è·å–å½“å‰ä¸»é¢˜çš„æ–‡å­—é¢œè‰²
                const currentTheme = document.body.getAttribute('data-theme');
                const textColor = currentTheme === 'dark' ? '#e0e0e0' : '#333333';
                
                ctx.fillStyle = textColor;
                ctx.font = '10px Arial';
                ctx.fillText(label, p.x + 8, p.y - 8);
            }
            
            // ä½¿ç”¨å½“å‰ä¸»é¢˜çš„é¢œè‰²
            const currentTheme = document.body.getAttribute('data-theme');
            const centerColor = currentTheme === 'dark' ? '#34a853' : '#0f9d58';
            const startColor = '#ea4335'; // çº¢è‰²ä¿æŒä¸å˜
            const pointColor = currentTheme === 'dark' ? '#5c9dff' : '#4285f4';
            
            drawPoint(O.x, O.y, "åœ†å¿ƒ (0,0)", centerColor, 5);
            drawPoint(A.x, A.y, `èµ·ç‚¹ (${A.x},${A.y})`, startColor, 5);
            
            points.forEach((point, index) => {
                let pointLabel = `ç‚¹${index+1}`;
                if (isCombinationMode) {
                    let templateIndex = 0;
                    let pointCount = 0;
                    
                    for (let i = 0; i < selectedTemplates.length; i++) {
                        const templateName = selectedTemplates[i];
                        const templatePoints = templates[templateName]?.points || [];
                        
                        if (index < pointCount + templatePoints.length) {
                            templateIndex = i;
                            break;
                        }
                        pointCount += templatePoints.length;
                    }
                    
                    pointLabel = `ç‚¹${templateIndex + 1}-${index - pointCount + 1}`;
                }
                
                drawPoint(point.x, point.y, `${pointLabel} (${point.x},${point.y})`, pointColor, 4);
            });
        }

        function drawAxes(scale, offsetX, offsetY) {
            ctx.beginPath();
            
            // è·å–å½“å‰ä¸»é¢˜çš„è½´çº¿é¢œè‰²
            const currentTheme = document.body.getAttribute('data-theme');
            const axisColor = currentTheme === 'dark' ? '#666' : '#ddd';
            
            ctx.strokeStyle = axisColor;
            ctx.lineWidth = 1;
            
            const xAxisY = canvas.height - (0 * scale + offsetY);
            ctx.moveTo(0, xAxisY);
            ctx.lineTo(canvas.width, xAxisY);
            
            const yAxisX = 0 * scale + offsetX;
            ctx.moveTo(yAxisX, 0);
            ctx.lineTo(yAxisX, canvas.height);
            
            ctx.stroke();
        }        
        function calculateViewport(points) {
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            points.forEach(point => {
                minX = Math.min(minX, point.x);
                maxX = Math.max(maxX, point.x);
                minY = Math.min(minY, point.y);
                maxY = Math.max(maxY, point.y);
            });
            
            const widthRange = Math.max(maxX - minX, 20);
            const heightRange = Math.max(maxY - minY, 20);
            const padding = 40;
            
            const scale = Math.min(
                (canvas.width - padding * 2) / widthRange,
                (canvas.height - padding * 2) / heightRange
            );
            
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            const offsetX = canvas.width / 2 - centerX * scale;
            const offsetY = canvas.height / 2 - centerY * scale;
            
            return { scale, offsetX, offsetY };
        }
        
        // ========== å·¥å…·å‡½æ•° ==========
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        // ========== åˆå§‹åŒ– ==========
        window.onload = async function() {
            // åˆå§‹åŒ–ç”»å¸ƒ
            initCanvas();
            
            // åˆå§‹åŒ–æ‚¬æµ®çƒ
            const toggle = new EdgeHideToggle({
                ballSize: isMobile ? 50 : 60,
                hideThreshold: 30,
                hideDelay: 2000,
                longPressDelay: 300,
                clickMaxMove: isMobile ? 10 : 5,
                deceleration: 0.95,
                minVelocity: 0.5,
                enableInertia: true,
                enableEdgeHide: true,
                enableVibrate: isMobile
            });
            
            // ç§»åŠ¨ç«¯æç¤º
            if (isMobile) {
                setTimeout(() => {
                    const hint = document.getElementById('touchHint');
                    if (hint) {
                        hint.style.display = 'block';
                        setTimeout(() => {
                            hint.style.display = 'none';
                        }, 5000);
                    }
                }, 1000);
            }
            
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ¿
            if (!loadTemplatesFromLocalStorage()) {
                // ä»GitHubåŠ è½½æ¨¡æ¿
                await loadTemplateFromGitHub();
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('programName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    exportProgram();
                }
            });
            
            ['xAdjustment', 'cAdjustment'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        calculateAdjustedValues();
                        calculateAdjustedProgram();
                    });
                }
            });
            
            // æ·»åŠ ESCé”®å…³é—­æ¨¡æ¿åº“
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTemplatePanel();
                    closeProgramNameModal();
                }
            });
            
            // é»˜è®¤åŠ è½½ä¸»è½´33æ¨¡æ¿
            if (templates['ä¸»è½´33']) {
                loadTemplate('ä¸»è½´33', true);
            }
            
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé˜²æ­¢é”®ç›˜å¼¹å‡ºæ—¶é¡µé¢æ»šåŠ¨
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
            
            // ä¿®å¤ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡»
            if (isMobile) {
                document.querySelectorAll('button').forEach(button => {
                    button.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        this.click();
                    });
                });
            }
        };
    </script>
</body>
</html>
[file content end]